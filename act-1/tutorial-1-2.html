<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Negotiation Problem - Accounting Origins</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState } = React;

        // Icon components
        const ChevronRight = (props) => (
            <svg {...props} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" d="M9 5l7 7-7 7" />
            </svg>
        );

        const Clock = (props) => (
            <svg {...props} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" />
                <path d="M12 6v6l4 2" />
            </svg>
        );

        const Book = (props) => (
            <svg {...props} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" />
                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" />
            </svg>
        );

        const CheckCircle = (props) => (
            <svg {...props} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                <path d="M22 4L12 14.01l-3-3" />
            </svg>
        );

        const HelpCircle = (props) => (
            <svg {...props} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" />
                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" />
                <path d="M12 17h.01" />
            </svg>
        );

        const Trophy = (props) => (
            <svg {...props} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
                <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6" />
                <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18" />
                <path d="M4 22h16" />
                <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22" />
                <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22" />
                <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z" />
            </svg>
        );

        const RefreshCw = (props) => (
            <svg {...props} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
                <path d="M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6M21 12a9 9 0 0 1-15 6.7L3 16" />
            </svg>
        );

        const Users = (props) => (
            <svg {...props} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                <circle cx="9" cy="7" r="4" />
                <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
                <path d="M16 3.13a4 4 0 0 1 0 7.75" />
            </svg>
        );

        const AlertCircle = (props) => (
            <svg {...props} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" />
                <path d="M12 8v4M12 16h.01" />
            </svg>
        );

        const Target = (props) => (
            <svg {...props} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" />
                <circle cx="12" cy="12" r="6" />
                <circle cx="12" cy="12" r="2" />
            </svg>
        );

        const MessageCircle = (props) => (
            <svg {...props} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
                <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z" />
            </svg>
        );

        const ArrowLeft = (props) => (
            <svg {...props} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
                <path d="M19 12H5M12 19l-7-7 7-7" />
            </svg>
        );

        // Inline SVG icons (custom)
        const HandshakeIcon = () => <svg viewBox="0 0 24 24" className="w-6 h-6" fill="currentColor"><path d="M11 6h3l3.29-3.3a1 1 0 0 1 1.42 0l2.58 2.59a1 1 0 0 1 0 1.41L19 9h-8V6zm-1 5v4l-2 2-3-3 2-2 1 1V9l-3.29 3.29a1 1 0 0 0 0 1.42l2.58 2.58a1 1 0 0 0 1.42 0L11 13v-2zm8 0-2 2v2l1-1 3 3-2 2-3.29-3.29a1 1 0 0 0-1.42 0L11 18v2h3l2.29 2.29a1 1 0 0 0 1.42 0l2.58-2.58a1 1 0 0 0 0-1.42L18 16v-5z"/></svg>;
        const WoolIcon = () => <svg viewBox="0 0 24 24" className="w-5 h-5" fill="currentColor"><circle cx="8" cy="8" r="3"/><circle cx="16" cy="8" r="3"/><circle cx="12" cy="14" r="3"/><circle cx="6" cy="16" r="2"/><circle cx="18" cy="16" r="2"/><circle cx="12" cy="20" r="2"/></svg>;
        const BarleyIcon = () => <svg viewBox="0 0 24 24" className="w-5 h-5" fill="currentColor"><path d="M12 2C12 2 10 6 10 8s1 3 2 3 2-1 2-3-2-6-2-6zm-4 6c0-2 2-6 2-6s-2 4-2 6 1 3 2 3 2-1 2-3m8 0c0-2-2-6-2-6s2 4 2 6-1 3-2 3-2-1-2-3m-4 6v8m-2-6l2-2 2 2"/></svg>;

        // Simple markdown renderer for explanations
        const renderMarkdown = (text) => {
          if (!text) return null;

          const lines = text.split('\n');
          const elements = [];
          let key = 0;

          for (let i = 0; i < lines.length; i++) {
            let line = lines[i];

            if (line.trim().startsWith('â€¢')) {
              const bulletContent = line.trim().substring(1).trim();
              elements.push(
                <div key={key++} className="flex items-start gap-2 ml-2 my-1">
                  <span className="text-gray-500">â€¢</span>
                  <span>{renderInlineMarkdown(bulletContent)}</span>
                </div>
              );
            }
            else if (line.trim() === '') {
              elements.push(<div key={key++} className="h-2" />);
            }
            else {
              elements.push(
                <p key={key++} className="my-1">{renderInlineMarkdown(line)}</p>
              );
            }
          }

          return <>{elements}</>;
        };

        const renderInlineMarkdown = (text) => {
          if (!text) return null;

          const parts = [];
          let remaining = text;
          let key = 0;

          while (remaining.length > 0) {
            const boldMatch = remaining.match(/\*\*(.+?)\*\*/);
            const italicMatch = remaining.match(/(?<!\*)\*([^*]+)\*(?!\*)/);

            let firstMatch = null;
            let matchType = null;

            if (boldMatch && (!italicMatch || boldMatch.index <= italicMatch.index)) {
              firstMatch = boldMatch;
              matchType = 'bold';
            } else if (italicMatch) {
              firstMatch = italicMatch;
              matchType = 'italic';
            }

            if (firstMatch) {
              if (firstMatch.index > 0) {
                parts.push(<span key={key++}>{remaining.substring(0, firstMatch.index)}</span>);
              }
              if (matchType === 'bold') {
                parts.push(<strong key={key++}>{firstMatch[1]}</strong>);
              } else {
                parts.push(<em key={key++}>{firstMatch[1]}</em>);
              }
              remaining = remaining.substring(firstMatch.index + firstMatch[0].length);
            } else {
              parts.push(<span key={key++}>{remaining}</span>);
              break;
            }
          }

          return parts.length > 0 ? <>{parts}</> : text;
        };

        const Tutorial12 = () => {
          const [phase, setPhase] = useState('intro');
          const [step, setStep] = useState(-1);
          const [answer, setAnswer] = useState('');
          const [showExplanation, setShowExplanation] = useState(false);
          const [hintIndex, setHintIndex] = useState(0);
          const [showGlossary, setShowGlossary] = useState(false);
          const [devMode, setDevMode] = useState(false);
          const [attemptCount, setAttemptCount] = useState(0);
          const [showIncorrectFeedback, setShowIncorrectFeedback] = useState(false);

          const [selectedPartner, setSelectedPartner] = useState(null);
          const [currentOffer, setCurrentOffer] = useState('');
          const [negotiationRound, setNegotiationRound] = useState(1);
          const [negotiationPhase, setNegotiationPhase] = useState('select');
          const [partnerResponse, setPartnerResponse] = useState(null);
          const [showBelowMinWarning, setShowBelowMinWarning] = useState(false);

          // Partner states: null (available), 'pending', 'declined', or { rate, rounds } (dealt)
          const [ashaState, setAshaState] = useState(null);
          const [merenState, setMerenState] = useState(null);
          const [ashaPendingOffer, setAshaPendingOffer] = useState(null); // { rate, rounds }
          const [merenPendingOffer, setMerenPendingOffer] = useState(null);
          
          // Legacy result tracking (for compatibility with existing code)
          const [ashaResult, setAshaResult] = useState(null);
          const [merenResult, setMerenResult] = useState(null);
          const [firstPartner, setFirstPartner] = useState(null);
          const [wantsSecondNegotiation, setWantsSecondNegotiation] = useState(null);

          const handleRestart = () => {
            setPhase('intro');
            setStep(-1);
            setAnswer('');
            setShowExplanation(false);
            setHintIndex(0);
            setAttemptCount(0);
            setShowIncorrectFeedback(false);
            setSelectedPartner(null);
            setCurrentOffer('');
            setNegotiationRound(1);
            setNegotiationPhase('select');
            setPartnerResponse(null);
            setShowBelowMinWarning(false);
            setAshaState(null);
            setMerenState(null);
            setAshaPendingOffer(null);
            setMerenPendingOffer(null);
            setAshaResult(null);
            setMerenResult(null);
            setFirstPartner(null);
            setWantsSecondNegotiation(null);
            window.scrollTo(0, 0);
          };

          const FAMILY_MINIMUM = 2;
          const ASHA_FLOOR = 4;
          const MEREN_FLOOR = 3;

          const colors = {
            primary: '#00356b',
            sand: '#f5f1e8',
            earth: '#8b7355',
            earthLight: '#d4c4a8',
            earthDark: '#5c4d3d',
            accent: '#c9a227'
          };

          const glossaryTerms = [
            { term: 'Reservation Price', definition: 'The minimum acceptable terms for a trade. Below this, you walk away. Your family\'s reservation price is 2 mina wool per sila barley.' },
            { term: 'Information Asymmetry', definition: 'When one party knows something the other doesn\'t. In negotiation, each side conceals their true minimum to get better terms.' },
            { term: 'Counter-offer', definition: 'A response to an offer that proposes different terms. Each counter-offer reveals information about what terms might be acceptable.' },
            { term: 'Strategic Concealment', definition: 'Deliberately hiding information (like your true minimum) to gain advantage in negotiation.' },
            { term: 'Exchange Rate', definition: 'The ratio at which one good trades for another. "4 mina wool per sila barley" means 4 units of wool for each unit of barley.' },
            { term: 'Value', definition: 'What your goods are "worth"â€”determined by the best exchange rate available to you, not by any inherent property of the goods.' }
          ];

          const characterProfiles = {
            asha: {
              name: 'Asha',
              location: 'eastern slope',
              floor: ASHA_FLOOR,
              description: 'Older shepherd, weathered hands, watchful eyes. She\'s traded wool for decades and gives nothing away.',
              personality: 'Patient and deliberate. Her responses are measured.',
              getResponse: (offer, round) => {
                const gap = offer - ASHA_FLOOR;
                if (offer <= ASHA_FLOOR) {
                  if (offer < ASHA_FLOOR) {
                    return { type: 'eager_accept', text: '"Done." She reaches for the barley before you can reconsider.', rate: offer };
                  } else {
                    return { type: 'reluctant_accept', text: 'Long silence. She looks at the barley, then at you, weighing something. Finally, a slow nod. "...That\'s acceptable."', rate: offer };
                  }
                }
                if (round === 3) {
                  return { type: 'final', text: '"4 mina per sila. That\'s my final offerâ€”take it or leave it." Said flatly, without anger. She means it.', counter: ASHA_FLOOR };
                }
                if (gap >= 5) {
                  return { type: 'counter', text: 'Doesn\'t blink. "I\'ll give you 2 mina per sila." No emotion.', counter: 2 };
                } else if (gap >= 3) {
                  return { type: 'counter', text: 'Slight shake of head. "Too much. I could do 2, perhaps 3 mina per sila."', counter: round === 1 ? 2 : 3 };
                } else if (gap === 2) {
                  return { type: 'counter', text: 'Pauses. Studies you. "3 mina per sila."', counter: 3 };
                } else {
                  return { type: 'counter', text: 'Long pause. Studies the barley, then the sky. "I might go as high as 3 mina per sila."', counter: 3 };
                }
              }
            },
            meren: {
              name: 'Meren',
              location: 'stone pens',
              floor: MEREN_FLOOR,
              description: 'Younger shepherd, eager to prove himself.',
              personality: 'More expressive. His counter-offers come quickly.',
              getResponse: (offer, round) => {
                const gap = offer - MEREN_FLOOR;
                if (offer <= MEREN_FLOOR) {
                  if (offer < MEREN_FLOOR) {
                    return { type: 'eager_accept', text: '"Deal!" He grabs your hand to shake before you finish speaking.', rate: offer };
                  } else {
                    return { type: 'reluctant_accept', text: 'He runs his hand through the wool, not looking at you. A long exhale. "Fine. Fine. We have a deal."', rate: offer };
                  }
                }
                if (round === 3) {
                  return { type: 'final', text: '"3 mina per silaâ€”take it or leave it." Voice tight. He\'s done negotiating and you can tell.', counter: MEREN_FLOOR };
                }
                if (gap >= 5) {
                  return { type: 'counter', text: 'Laughs, but not kindly. "You\'re joking. 1 mina per sila, if you\'re serious."', counter: 1 };
                } else if (gap >= 3) {
                  return { type: 'counter', text: 'Frowns. "That\'s... no. I\'ll give you ' + (round === 1 ? '1, maybe 2' : '2') + ' mina per sila."', counter: round === 1 ? 1 : 2 };
                } else if (gap === 2) {
                  return { type: 'counter', text: 'Crosses arms. "I\'m not giving my wool away. 2 mina per sila."', counter: 2 };
                } else {
                  return { type: 'counter', text: 'Hesitates. You see him calculating. "2 mina per sila. That\'s fair."', counter: 2 };
                }
              }
            }
          };

          const questions = [
            {
              id: 0,
              narrative: "Before you left this morning, your father pulled you aside.\n\n\"We need wool for winter cloaks. But don't give away our barley for nothing.\"\n\nHe hands you the basket. \"Bring back at least 2 mina of wool for each sila of barley. Any less and we're trading too much grain for too little woolâ€”we won't have enough left for planting season.\"",
              question: "What is the minimum exchange rate your family will accept?",
              type: "mandate",
              hints: ["Your father was specific about the terms.", "This is your \"walk away\" pointâ€”below this, you don't trade."],
              evaluate: (a) => a.toLowerCase().includes('2') && (a.toLowerCase().includes('mina') || a.toLowerCase().includes('wool')),
              answer: "2 mina wool per sila barley",
              explanation: "Your family's mandate is clear: at least 2 mina of wool for each sila of barley. This is your reservation priceâ€”the minimum acceptable terms. Below this, you walk away.\n\nBut here's the thing: Asha and Meren don't know your minimum. And you don't know their maximum. This mutual uncertainty is the core of the negotiation problem."
            },
            {
              id: 1,
              narrative: "You arrive at the hills. Asha is tending her flock near the eastern slope. Meren is by the stone pens to the west. Both notice you and your basket of barley.\n\nYou can negotiate with either one. Each negotiation takes time and energyâ€”and might fail entirely.",
              question: "Choose a trading partner and negotiate. Make offers until you reach a deal.\n\nðŸŽ¯ Your goal: Get the most wool per sila of barley.\nâš ï¸ Your constraint: At least 2 mina per sila.",
              type: "negotiation1",
              hints: ["You don't know their maximum. They're not going to tell you.", "Each counter-offer tells you something: at least they won't give more than that.", "Think about what you're learning with each exchange."],
              evaluate: () => {
                // Only complete when we have an actual accepted deal (not pending, not failed)
                const hasAshaDealt = ashaState && typeof ashaState === 'object' && ashaState.rate;
                const hasMerenDealt = merenState && typeof merenState === 'object' && merenState.rate;
                return hasAshaDealt || hasMerenDealt;
              },
              answer: "Complete negotiation",
              explanation: ""
            },
            {
              id: 2,
              narrative: "",
              question: "",
              type: "choice",
              hints: [],
              evaluate: () => wantsSecondNegotiation !== null,
              answer: "Make a choice",
              explanation: ""
            },
            {
              id: 3,
              narrative: "You approach the other trader.\n\n\"I see you have barley,\" they say, eyeing your basket. \"I might be interested.\"\n\nYou've been through this once already. You know how it works now.",
              question: "Negotiate with the other partner. Make offers until you reach a deal or the negotiation fails.",
              type: "negotiation2",
              hints: ["You know the process now.", "Will this partner offer different terms?", "Compare to what you got (or didn't get) from the first negotiation."],
              evaluate: () => negotiationPhase === 'complete' || negotiationPhase === 'failed',
              answer: "Complete negotiation",
              explanation: ""
            },
            {
              id: 4,
              narrative: "That evening, you sit by the fire, thinking about what happened in the hills.\n\nBut here's something you couldn't have known during the negotiations:",
              question: "Compare your results to what was possible. What did the information gap cost you?",
              type: "reveal",
              hints: ["Look at the difference between what you got and what was possible.", "Every mina of wool you \"left on the table\" is wool your family won't have.", "If you failed to make a deal, that's the highest cost of all."],
              evaluate: (a) => a.length > 20,
              answer: "Reflection on the information gap",
              explanation: ""
            },
            {
              id: 5,
              narrative: "You have the information nowâ€”the actual exchange rates from your negotiations. Think about what this means.\n\nYou had the same basket of barley throughout. But Asha would give you 4 mina per sila. Meren would give you 3.\n\nSame barley. Different amounts of wool.",
              question: "Based on your negotiations, what is your barley \"worth\"?",
              type: "value",
              hints: ["You could have traded with either partner...", "One gives you more wool than the other...", "Which exchange rate determines the value of your barley?"],
              evaluate: (a) => {
                const lower = a.toLowerCase();
                return (lower.includes('4') || lower.includes('asha') || lower.includes('best') || lower.includes('most') || lower.includes('higher') || lower.includes('maximum'));
              },
              answer: "The best available rate (Asha's rate of 4 mina per sila)",
              explanation: "Your barley is worth whatever gets you the most wool. That's Asha's rate: 4 mina per sila.\n\nThe \"value\" of your barley isn't some number attached to the grain itself. It's determined by the best exchange available to you. If you only knew about Meren, you'd think your barley was worth 3 mina per sila. Finding Ashaâ€”and negotiating successfullyâ€”revealed that it's actually worth more.\n\nThis is why search mattered in Tutorial 1.1. The more potential partners you find, the more likely you are to find the best terms. And the best terms determine the value of what you have."
            }
          ];

          const handleMakeOffer = () => {
            const offer = parseInt(currentOffer);
            if (isNaN(offer) || offer < 1) return;

            const partner = characterProfiles[selectedPartner];
            const response = partner.getResponse(offer, negotiationRound);

            setPartnerResponse(response);
            setNegotiationPhase('response');
          };

          const handleAccept = (rate) => {
            if (rate < FAMILY_MINIMUM) {
              setShowBelowMinWarning(true);
              return;
            }

            const result = { rate, rounds: negotiationRound };
            if (selectedPartner === 'asha') {
              setAshaResult(result);
              setAshaState(result);
              setAshaPendingOffer(null);
            } else {
              setMerenResult(result);
              setMerenState(result);
              setMerenPendingOffer(null);
            }
            setNegotiationPhase('complete');
          };

          const handleWalkAway = () => {
            if (selectedPartner === 'asha') {
              setAshaResult('failed');
              setAshaState('declined');
            } else {
              setMerenResult('failed');
              setMerenState('declined');
            }
            setNegotiationPhase('failed');
          };
          
          const handleThinkAboutIt = (rate) => {
            // Store this as a pending offer
            const pendingOffer = { rate, rounds: negotiationRound };
            if (selectedPartner === 'asha') {
              setAshaPendingOffer(pendingOffer);
              setAshaState('pending');
            } else {
              setMerenPendingOffer(pendingOffer);
              setMerenState('pending');
            }
            // Return to partner selection
            setSelectedPartner(null);
            setNegotiationPhase('select');
            setCurrentOffer('');
            setPartnerResponse(null);
            setNegotiationRound(1);
          };
          
          const handleAcceptPendingOffer = (partner) => {
            const pendingOffer = partner === 'asha' ? ashaPendingOffer : merenPendingOffer;
            if (!pendingOffer) return;
            
            const result = { rate: pendingOffer.rate, rounds: pendingOffer.rounds };
            if (partner === 'asha') {
              setAshaResult(result);
              setAshaState(result);
              setAshaPendingOffer(null);
            } else {
              setMerenResult(result);
              setMerenState(result);
              setMerenPendingOffer(null);
            }
            setNegotiationPhase('complete');
          };

          const handleMakeAnother = () => {
            setNegotiationRound(negotiationRound + 1);
            setCurrentOffer('');
            setPartnerResponse(null);
            setNegotiationPhase('offer');
          };

          const handleRestartAfterWarning = () => {
            setShowBelowMinWarning(false);
            setNegotiationRound(1);
            setCurrentOffer('');
            setPartnerResponse(null);
            setNegotiationPhase('offer');
          };

          const handleSelectPartner = (partner) => {
            setSelectedPartner(partner);
            if (!firstPartner) setFirstPartner(partner);
            setNegotiationRound(1);
            setCurrentOffer('');
            setPartnerResponse(null);
            setNegotiationPhase('offer');
          };

          const handleSecondNegotiationChoice = (wants) => {
            setWantsSecondNegotiation(wants);
            if (!wants) {
              const otherPartner = firstPartner === 'asha' ? 'meren' : 'asha';
              if (otherPartner === 'asha') {
                setAshaResult('skipped');
              } else {
                setMerenResult('skipped');
              }
            }
          };

          const handleSubmit = () => {
            const q = questions.find(q => q.id === step);
            if (q && q.evaluate(answer)) {
              setShowExplanation(true);
              setShowIncorrectFeedback(false);
            } else {
              const newAttemptCount = attemptCount + 1;
              setAttemptCount(newAttemptCount);
              if (newAttemptCount >= 3) {
                setShowExplanation(true);
                setShowIncorrectFeedback(false);
              } else {
                setShowIncorrectFeedback(true);
              }
            }
          };

          const nextStep = () => {
            setAnswer('');
            setShowExplanation(false);
            setHintIndex(0);
            setAttemptCount(0);
            setShowIncorrectFeedback(false);

            if (step === 1) {
              // Skip Q2 (choice) and Q3 (negotiation2) - go straight to Q4 (reveal)
              setStep(4);
              setNegotiationPhase('select');
              setSelectedPartner(null);
            } else if (step < 5) {
              setStep(step + 1);
            } else {
              setPhase('complete');
            }
            window.scrollTo(0, 0);
          };

          const getExplanation = () => {
            const q = questions.find(q => q.id === step);
            if (!q) return '';

            if (q.type === 'negotiation1') {
              // Find the deal that was made
              const hasAshaDeal = ashaState && typeof ashaState === 'object' && ashaState.rate;
              const hasMerenDeal = merenState && typeof merenState === 'object' && merenState.rate;
              
              if (hasAshaDeal) {
                const result = ashaState;
                return `You made a deal with Asha: ${result.rate} mina of wool per sila of barley.\n\nBut was this the best you could do? The negotiation revealed that Asha would accept ${result.rate}â€”but would she have given more? That information remained hidden.`;
              } else if (hasMerenDeal) {
                const result = merenState;
                return `You made a deal with Meren: ${result.rate} mina of wool per sila of barley.\n\nBut was this the best you could do? The negotiation revealed that Meren would accept ${result.rate}â€”but would he have given more? That information remained hidden.`;
              }
              return "The negotiation is complete.";
            }

            if (q.type === 'choice') {
              if (wantsSecondNegotiation) {
                return "You decide to try the other partner. More information about what's possible in this valley.";
              } else {
                const firstResult = firstPartner === 'asha' ? ashaResult : merenResult;
                if (firstResult === 'failed') {
                  return "You return home without wool. Your family will face the winter cold.";
                }
                return "You're satisfied with your deal. But you'll never know if the other partner would have offered more.";
              }
            }

            if (q.type === 'negotiation2') {
              const otherPartner = firstPartner === 'asha' ? 'meren' : 'asha';
              const result = otherPartner === 'asha' ? ashaResult : merenResult;
              const partner = characterProfiles[otherPartner];

              let comparison = '\n\n**Your negotiations:**\n';
              const firstResult = firstPartner === 'asha' ? ashaResult : merenResult;
              const firstName = characterProfiles[firstPartner].name;
              comparison += `â€¢ ${firstName}: ${firstResult === 'failed' ? 'Failed' : firstResult.rate + ' mina/sila'}\n`;
              comparison += `â€¢ ${partner.name}: ${result === 'failed' ? 'Failed' : result.rate + ' mina/sila'}`;

              if (result === 'failed' && firstResult === 'failed') {
                return `Both negotiations failed. You return home without wool. The information problem was too costly to overcome.` + comparison;
              } else if (result === 'failed' || firstResult === 'failed') {
                return `One deal, one failure. Negotiation is uncertainâ€”the same approach can succeed with one partner and fail with another.` + comparison;
              } else if (result.rate !== firstResult.rate) {
                return `You got different terms from each partner. The same barley. The same wool. Different exchange rates.\n\nThink about what this means: your barley doesn't have a single "value." Its value depends on who you trade with.` + comparison;
              } else {
                return `You got the same terms from both partners.` + comparison;
              }
            }

            if (q.type === 'reveal') {
              // Get the actual deal
              const hasAshaDeal = ashaState && typeof ashaState === 'object' && ashaState.rate;
              const hasMerenDeal = merenState && typeof merenState === 'object' && merenState.rate;
              const dealPartner = hasAshaDeal ? 'Asha' : (hasMerenDeal ? 'Meren' : null);
              const dealResult = hasAshaDeal ? ashaState : (hasMerenDeal ? merenState : null);
              const yourWool = dealResult ? dealResult.rate : 0;
              const bestWool = ASHA_FLOOR;
              
              // Calculate total rounds
              let totalRounds = 0;
              if (ashaState === 'pending' && ashaPendingOffer) totalRounds += ashaPendingOffer.rounds;
              else if (ashaState === 'declined') totalRounds += 3;
              else if (hasAshaDeal) totalRounds += ashaState.rounds;
              if (merenState === 'pending' && merenPendingOffer) totalRounds += merenPendingOffer.rounds;
              else if (merenState === 'declined') totalRounds += 3;
              else if (hasMerenDeal) totalRounds += merenState.rounds;
              if (totalRounds === 0 && dealResult) totalRounds = dealResult.rounds;
              
              let explanation = `**The Cost of Hidden Information**\n\nLet's count what this negotiation cost you:\n\n`;
              
              // 1. Outcome Cost
              explanation += `**1. Outcome Cost â€” the wool you didn't get**\n`;
              explanation += `â€¢ You got: **${yourWool} mina of wool**\n`;
              explanation += `â€¢ Best possible: **${bestWool} mina of wool** (Asha's true maximum)\n`;
              if (yourWool >= bestWool) {
                explanation += `â€¢ **You achieved the best possible outcome!**\n\n`;
              } else {
                explanation += `â€¢ Gap: ${bestWool - yourWool} mina of wool your family won't have\n\n`;
              }
              
              // 2. Process Cost
              explanation += `**2. Process Cost â€” the time and energy spent negotiating**\n`;
              explanation += `â€¢ Total rounds: **${totalRounds}**\n`;
              explanation += `â€¢ Each round: offers, counter-offers, reading reactions, second-guessing\n`;
              explanation += `â€¢ All to discover information each party was actively hiding\n\n`;
              
              // 3. Uncertainty Cost
              explanation += `**3. Uncertainty Cost â€” you still don't know**\n`;
              if (dealPartner === 'Asha') {
                explanation += `â€¢ Was 4 really Asha's limit? Or would she have gone higher?\n`;
              } else {
                explanation += `â€¢ Was ${yourWool} really ${dealPartner}'s limit? Or would they have gone higher?\n`;
              }
              explanation += `â€¢ You'll never know for certain. They had every reason to hide it.\n\n`;
              
              explanation += `---\n\nThis is the **cost of information asymmetry**. Not just worse outcomesâ€”but the exhausting process of extracting information that others are strategically concealing.`;
              
              return explanation;
            }

            return q.explanation;
          };

          const getChoiceNarrative = () => {
            const firstResult = firstPartner === 'asha' ? ashaResult : merenResult;
            const otherPartner = firstPartner === 'asha' ? 'Meren' : 'Asha';

            if (firstResult === 'failed') {
              return `Your negotiation with ${characterProfiles[firstPartner].name} failed. But ${otherPartner} is still here. You still need wool.`;
            }
            return `You have a deal with ${characterProfiles[firstPartner].name}: ${firstResult.rate} mina per sila. But ${otherPartner} is still here, tending their flock. They also have wool. They also want barley.\n\nWould they offer better terms?`;
          };

          const getChoiceQuestion = () => {
            const firstResult = firstPartner === 'asha' ? ashaResult : merenResult;
            const otherPartner = firstPartner === 'asha' ? 'Meren' : 'Asha';

            if (firstResult === 'failed') {
              return `Do you want to try negotiating with ${otherPartner}?`;
            }
            return `You have a deal. Do you want to negotiate with ${otherPartner} to see if you can get better terms?`;
          };

          const GlossaryModal = ({ terms, colors, onClose }) => (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
              <div className="bg-white rounded-xl max-w-lg w-full max-h-[80vh] overflow-y-auto">
                <div className="p-4 border-b flex justify-between items-center" style={{ borderColor: colors.earthLight }}>
                  <h2 className="font-bold text-lg" style={{ color: colors.primary }}>Glossary</h2>
                  <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-xl">Ã—</button>
                </div>
                <div className="p-4">
                  {terms.map((t, i) => (
                    <div key={i} className="mb-4 last:mb-0">
                      <h3 className="font-bold text-sm" style={{ color: colors.earthDark }}>{t.term}</h3>
                      <p className="text-gray-600 text-sm">{t.definition}</p>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          );

          const Header = () => (
            <div className="p-3 text-white flex items-center justify-between" style={{ backgroundColor: colors.primary }}>
              <div className="flex items-center gap-2">
                <HandshakeIcon />
                <span className="font-bold">Tutorial 1.2</span>
              </div>
              <div className="flex items-center gap-2 text-xs">
                <Clock className="w-4 h-4" />
                <span>~12 min</span>
              </div>
            </div>
          );

          const PartnerSelector = ({ onSelect }) => {
            const getPartnerStatus = (partner) => {
              const state = partner === 'asha' ? ashaState : merenState;
              const pendingOffer = partner === 'asha' ? ashaPendingOffer : merenPendingOffer;
              
              if (state === 'declined') return { label: 'Walked away', color: 'bg-gray-100 text-gray-500', disabled: true };
              if (state === 'pending') return { label: `Pending: ${pendingOffer?.rate} mina`, color: 'bg-yellow-100 text-yellow-800', disabled: false, isPending: true };
              if (state && typeof state === 'object') return { label: `Deal: ${state.rate} mina`, color: 'bg-green-100 text-green-800', disabled: true };
              return { label: 'Available', color: 'bg-blue-100 text-blue-800', disabled: false };
            };

            const ashaStatus = getPartnerStatus('asha');
            const merenStatus = getPartnerStatus('meren');
            
            const handlePartnerClick = (partnerId, status) => {
              if (status.isPending) {
                setSelectedPartner(partnerId);
                setNegotiationPhase('pendingOffer');
              } else {
                onSelect(partnerId);
              }
            };

            return (
              <div className="space-y-3">
                <p className="text-sm text-gray-600 mb-3">Who do you want to negotiate with?</p>
                
                {/* Asha */}
                <button
                  onClick={() => handlePartnerClick('asha', ashaStatus)}
                  disabled={ashaStatus.disabled}
                  className={`w-full p-4 rounded-lg border text-left transition-all ${ashaStatus.disabled ? 'opacity-50 cursor-not-allowed bg-gray-100' : 'hover:border-blue-300 hover:bg-blue-50'}`}
                  style={{ borderColor: colors.earthLight }}
                >
                  <div className="flex items-center gap-3">
                    <div className="w-12 h-12 rounded-full flex items-center justify-center" style={{ backgroundColor: colors.sand }}>
                      <Users className="w-6 h-6" style={{ color: colors.earth }} />
                    </div>
                    <div className="flex-1">
                      <div className="font-bold" style={{ color: colors.earthDark }}>{characterProfiles.asha.name}</div>
                      <div className="text-xs text-gray-500">{characterProfiles.asha.location}</div>
                      <div className="text-xs text-gray-600 mt-1">{characterProfiles.asha.description}</div>
                      <span className={`inline-block mt-2 text-xs px-2 py-1 rounded-full ${ashaStatus.color}`}>
                        {ashaStatus.label}
                      </span>
                      {ashaStatus.isPending && (
                        <p className="text-xs mt-1 text-yellow-700">Click to accept or check other partner</p>
                      )}
                    </div>
                    {ashaStatus.disabled && !ashaStatus.isPending && <CheckCircle className="w-5 h-5 text-green-500" />}
                  </div>
                </button>

                {/* Meren */}
                <button
                  onClick={() => handlePartnerClick('meren', merenStatus)}
                  disabled={merenStatus.disabled}
                  className={`w-full p-4 rounded-lg border text-left transition-all ${merenStatus.disabled ? 'opacity-50 cursor-not-allowed bg-gray-100' : 'hover:border-blue-300 hover:bg-blue-50'}`}
                  style={{ borderColor: colors.earthLight }}
                >
                  <div className="flex items-center gap-3">
                    <div className="w-12 h-12 rounded-full flex items-center justify-center" style={{ backgroundColor: colors.sand }}>
                      <Users className="w-6 h-6" style={{ color: colors.earth }} />
                    </div>
                    <div className="flex-1">
                      <div className="font-bold" style={{ color: colors.earthDark }}>{characterProfiles.meren.name}</div>
                      <div className="text-xs text-gray-500">{characterProfiles.meren.location}</div>
                      <div className="text-xs text-gray-600 mt-1">{characterProfiles.meren.description}</div>
                      <span className={`inline-block mt-2 text-xs px-2 py-1 rounded-full ${merenStatus.color}`}>
                        {merenStatus.label}
                      </span>
                      {merenStatus.isPending && (
                        <p className="text-xs mt-1 text-yellow-700">Click to accept or check other partner</p>
                      )}
                    </div>
                    {merenStatus.disabled && !merenStatus.isPending && <CheckCircle className="w-5 h-5 text-green-500" />}
                  </div>
                </button>
              </div>
            );
          };

          const NegotiationInterface = () => {
            const partner = characterProfiles[selectedPartner];
            
            // Get other partner's status for context
            const otherPartner = selectedPartner === 'asha' ? 'meren' : 'asha';
            const otherState = otherPartner === 'asha' ? ashaState : merenState;
            const otherPending = otherPartner === 'asha' ? ashaPendingOffer : merenPendingOffer;
            const otherName = characterProfiles[otherPartner].name;

            // Pending offer interface
            if (negotiationPhase === 'pendingOffer') {
              const pendingOffer = selectedPartner === 'asha' ? ashaPendingOffer : merenPendingOffer;
              return (
                <div className="space-y-4">
                  <div className="p-4 rounded-xl" style={{ backgroundColor: colors.sand }}>
                    <p className="italic text-gray-700">
                      {partner.name} is still here, waiting. The offer of <strong>{pendingOffer.rate} mina</strong> still stands.
                    </p>
                  </div>

                  <div className="space-y-2">
                    <button
                      onClick={() => handleAcceptPendingOffer(selectedPartner)}
                      className="w-full py-3 rounded-lg font-medium text-white"
                      style={{ backgroundColor: colors.primary }}
                    >
                      Accept {pendingOffer.rate} mina from {partner.name}
                    </button>
                    <button
                      onClick={() => {
                        setSelectedPartner(null);
                        setNegotiationPhase('select');
                      }}
                      className="w-full py-3 rounded-lg font-medium border-2 flex items-center justify-center gap-2"
                      style={{ borderColor: colors.earthLight, color: colors.earthDark }}
                    >
                      <ArrowLeft className="w-4 h-4" />
                      Return to Partner Selection
                    </button>
                  </div>
                  
                  {/* Other partner status */}
                  {otherState === 'pending' && (
                    <div className="p-3 rounded-lg text-sm bg-yellow-50 border border-yellow-200">
                      <p className="text-yellow-800">ðŸ’¡ {otherName} also has a pending offer of <strong>{otherPending?.rate} mina</strong></p>
                    </div>
                  )}
                </div>
              );
            }

            if (showBelowMinWarning) {
              return (
                <div className="p-4 rounded-lg border-2 border-red-300 bg-red-50">
                  <div className="flex items-start gap-3">
                    <AlertCircle className="w-6 h-6 text-red-500 flex-shrink-0 mt-0.5" />
                    <div>
                      <p className="font-medium text-red-800 mb-2">Waitâ€”this doesn't meet your family's needs.</p>
                      <p className="text-sm text-red-700 mb-3">
                        You start to agree, but something stops you. Your father's words echo: "At least 2 mina per sila."
                      </p>
                      <p className="text-sm text-red-700 mb-4">
                        This deal is below your family's minimum. You'll have to try again.
                      </p>
                      <button
                        onClick={handleRestartAfterWarning}
                        className="px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 text-white"
                        style={{ backgroundColor: colors.primary }}
                      >
                        <RefreshCw className="w-4 h-4" /> Try Again
                      </button>
                    </div>
                  </div>
                </div>
              );
            }

            if (negotiationPhase === 'offer') {
              return (
                <div className="space-y-4">
                  <div className="p-3 rounded-lg" style={{ backgroundColor: colors.sand }}>
                    <div className="flex items-center gap-2 mb-2">
                      <Users className="w-5 h-5" style={{ color: colors.earth }} />
                      <span className="font-medium" style={{ color: colors.earthDark }}>Negotiating with {partner.name}</span>
                      <span className="ml-auto text-xs px-2 py-1 rounded bg-white" style={{ color: colors.primary }}>Round {negotiationRound}/3</span>
                    </div>
                    <p className="text-xs text-gray-600 italic">{partner.personality}</p>
                  </div>

                  <div className="p-4 rounded-lg border" style={{ borderColor: colors.earthLight }}>
                    <label className="block text-sm font-medium mb-2" style={{ color: colors.earthDark }}>
                      Make your offer:
                    </label>
                    <div className="flex items-center gap-2">
                      <span className="text-sm text-gray-600">For 1 sila of barley, I want</span>
                      <input
                        type="number"
                        min="1"
                        max="20"
                        value={currentOffer}
                        onChange={(e) => setCurrentOffer(e.target.value)}
                        className="w-16 p-2 border rounded text-center font-bold"
                        style={{ borderColor: colors.earthLight }}
                      />
                      <span className="text-sm text-gray-600">mina of wool.</span>
                    </div>
                    <div className="flex gap-2 mt-3">
                      <button
                        onClick={() => {
                          setSelectedPartner(null);
                          setNegotiationPhase('select');
                          setCurrentOffer('');
                        }}
                        className="px-4 py-2 rounded-lg text-sm flex items-center gap-1"
                        style={{ backgroundColor: colors.sand, color: colors.earthDark }}
                      >
                        <ArrowLeft className="w-4 h-4" /> Back
                      </button>
                      <button
                        onClick={handleMakeOffer}
                        disabled={!currentOffer || parseInt(currentOffer) < 1}
                        className="flex-1 text-white py-2 rounded-lg text-sm font-medium disabled:opacity-50"
                        style={{ backgroundColor: colors.primary }}
                      >
                        Submit Offer
                      </button>
                    </div>
                  </div>

                  <div className="text-xs text-gray-500 flex items-center gap-2">
                    <Target className="w-4 h-4" />
                    Remember: Your family needs at least 2 mina per sila
                  </div>
                  
                  {/* Show pending offer reminder if other partner has one */}
                  {otherState === 'pending' && (
                    <div className="p-3 rounded-lg text-sm bg-yellow-50 border border-yellow-200">
                      <p className="text-yellow-800">
                        ðŸ’¡ Remember: {otherName} has a pending offer of <strong>{otherPending?.rate} mina</strong>. 
                        You can go back to accept it anytime.
                      </p>
                    </div>
                  )}
                </div>
              );
            }

            if (negotiationPhase === 'response' && partnerResponse) {
              const isAccept = partnerResponse.type === 'eager_accept' || partnerResponse.type === 'reluctant_accept';
              const isFinal = partnerResponse.type === 'final';
              const isRejection = partnerResponse.type === 'counter';

              return (
                <div className="space-y-4">
                  <div className="p-3 rounded-lg" style={{ backgroundColor: colors.sand }}>
                    <div className="flex items-center gap-2">
                      <Users className="w-5 h-5" style={{ color: colors.earth }} />
                      <span className="font-medium" style={{ color: colors.earthDark }}>{partner.name}'s Response</span>
                      <span className="ml-auto text-xs px-2 py-1 rounded bg-white" style={{ color: colors.primary }}>Round {negotiationRound}/3</span>
                    </div>
                  </div>

                  {/* Status banner - Rejection or Acceptance */}
                  {isRejection ? (
                    <div className="p-4 rounded-lg border-l-4" style={{ backgroundColor: '#fef2f2', borderColor: '#dc2626' }}>
                      <div className="flex items-center gap-2 mb-2">
                        <span className="font-bold text-red-800">âœ— OFFER REJECTED</span>
                      </div>
                      <p className="text-gray-700 italic">{partnerResponse.text}</p>
                      {partnerResponse.counter && (
                        <p className="mt-2 font-medium text-gray-800">
                          Counter-offer: <strong>{partnerResponse.counter} mina</strong>
                        </p>
                      )}
                    </div>
                  ) : (
                    <div className="p-4 rounded-lg border-l-4" style={{
                      backgroundColor: isAccept ? '#f0fff4' : '#fef3c7',
                      borderColor: isAccept ? '#22c55e' : colors.accent
                    }}>
                      {isAccept && (
                        <div className="flex items-center gap-2 mb-2">
                          <CheckCircle className="w-5 h-5 text-green-600" />
                          <span className="font-bold text-green-800">âœ“ OFFER ACCEPTED</span>
                        </div>
                      )}
                      <p className="text-gray-700 italic">{partnerResponse.text}</p>
                    </div>
                  )}

                  {isAccept ? (
                    <div className="p-4 rounded-lg bg-green-50 border border-green-200">
                      <p className="font-bold text-green-800 mb-2">Deal Available: {partnerResponse.rate} mina/sila</p>
                      <div className="space-y-2">
                        <button
                          onClick={() => handleAccept(partnerResponse.rate)}
                          className="w-full py-2 rounded-lg text-sm font-medium text-white bg-green-600 hover:bg-green-700"
                        >
                          Accept Deal
                        </button>
                        <button
                          onClick={() => handleThinkAboutIt(partnerResponse.rate)}
                          className="w-full py-2 rounded-lg text-sm font-medium border-2 flex items-center justify-center gap-2"
                          style={{ borderColor: colors.accent, color: colors.earthDark }}
                        >
                          "Let me think about it" (check other partner)
                        </button>
                      </div>
                    </div>
                  ) : isFinal ? (
                    <div className="space-y-2">
                      <p className="text-sm font-medium" style={{ color: colors.earthDark }}>
                        Final offer: {partnerResponse.counter} mina per sila
                      </p>
                      <button
                        onClick={() => handleAccept(partnerResponse.counter)}
                        className="w-full py-2 rounded-lg text-sm font-medium text-white bg-green-600 hover:bg-green-700"
                      >
                        Accept ({partnerResponse.counter} mina/sila)
                      </button>
                      <button
                        onClick={() => handleThinkAboutIt(partnerResponse.counter)}
                        className="w-full py-2 rounded-lg text-sm font-medium border-2 flex items-center justify-center gap-2"
                        style={{ borderColor: colors.accent, color: colors.earthDark }}
                      >
                        "Let me think about it" (check other partner)
                      </button>
                      <button
                        onClick={handleWalkAway}
                        className="w-full py-2 rounded-lg text-sm font-medium bg-gray-200 hover:bg-gray-300"
                        style={{ color: colors.earthDark }}
                      >
                        Walk Away (decline permanently)
                      </button>
                    </div>
                  ) : (
                    <div className="space-y-2">
                      <button
                        onClick={() => handleAccept(partnerResponse.counter)}
                        className="w-full py-2 rounded-lg text-sm font-medium text-white bg-green-600 hover:bg-green-700"
                      >
                        Accept ({partnerResponse.counter} mina/sila)
                      </button>
                      <button
                        onClick={handleMakeAnother}
                        className="w-full py-2 rounded-lg text-sm font-medium"
                        style={{ backgroundColor: colors.sand, color: colors.earthDark }}
                      >
                        Make New Offer
                      </button>
                      {/* Show return option if other partner has pending offer */}
                      {otherState === 'pending' && (
                        <button
                          onClick={() => {
                            setSelectedPartner(null);
                            setNegotiationPhase('select');
                            setCurrentOffer('');
                            setPartnerResponse(null);
                          }}
                          className="w-full py-2 rounded-lg text-sm font-medium text-gray-600 border border-gray-300 flex items-center justify-center gap-2"
                        >
                          <ArrowLeft className="w-4 h-4" />
                          Return to Partner Selection ({otherName} has {otherPending?.rate} mina pending)
                        </button>
                      )}
                    </div>
                  )}
                  
                  {/* Pending offer reminder */}
                  {otherState === 'pending' && !isFinal && !isAccept && (
                    <div className="p-3 rounded-lg text-sm bg-yellow-50 border border-yellow-200">
                      <p className="text-yellow-800">
                        ðŸ’¡ Remember: {otherName} has a pending offer of <strong>{otherPending?.rate} mina</strong>.
                      </p>
                    </div>
                  )}
                </div>
              );
            }

            if (negotiationPhase === 'complete') {
              const result = selectedPartner === 'asha' ? ashaResult : merenResult;
              return (
                <div className="space-y-4">
                  <div className="p-4 rounded-lg bg-green-50 border border-green-200">
                    <div className="flex items-center gap-2 mb-2">
                      <CheckCircle className="w-6 h-6 text-green-600" />
                      <span className="font-bold text-green-800">Deal Complete!</span>
                    </div>
                    <p className="text-green-700">
                      You agreed to trade at {result.rate} mina of wool per sila of barley with {partner.name}.
                    </p>
                    <p className="text-green-600 text-sm mt-1">
                      Negotiation took {result.rounds} round{result.rounds > 1 ? 's' : ''}.
                    </p>
                  </div>
                  <button
                    onClick={() => setShowExplanation(true)}
                    className="w-full text-white py-2 rounded-lg text-sm font-medium"
                    style={{ backgroundColor: colors.primary }}
                  >
                    Continue
                  </button>
                </div>
              );
            }

            if (negotiationPhase === 'failed') {
              return (
                <div className="p-4 rounded-lg bg-red-50 border border-red-200">
                  <div className="flex items-center gap-2 mb-2">
                    <AlertCircle className="w-6 h-6 text-red-600" />
                    <span className="font-bold text-red-800">Negotiation Failed</span>
                  </div>
                  <p className="text-red-700">
                    {partner.name} turns back to their work. No deal was reached.
                  </p>
                </div>
              );
            }

            return null;
          };

          const ChoiceInterface = () => {
            const firstResult = firstPartner === 'asha' ? ashaResult : merenResult;
            const otherPartner = firstPartner === 'asha' ? 'Meren' : 'Asha';

            return (
              <div className="space-y-3">
                {firstResult !== 'failed' && (
                  <div className="p-3 rounded-lg bg-green-50 border border-green-200 mb-4">
                    <p className="text-sm text-green-700">
                      <strong>Current deal:</strong> {firstResult.rate} mina/sila with {characterProfiles[firstPartner].name}
                    </p>
                  </div>
                )}

                <button
                  onClick={() => handleSecondNegotiationChoice(true)}
                  className="w-full p-4 rounded-lg border text-left hover:border-blue-300 hover:bg-blue-50"
                  style={{ borderColor: colors.earthLight }}
                >
                  <div className="font-medium" style={{ color: colors.earthDark }}>Yes, negotiate with {otherPartner}</div>
                  <div className="text-xs text-gray-500 mt-1">See if you can get better terms</div>
                </button>

                <button
                  onClick={() => handleSecondNegotiationChoice(false)}
                  className="w-full p-4 rounded-lg border text-left hover:border-gray-400 hover:bg-gray-50"
                  style={{ borderColor: colors.earthLight }}
                >
                  <div className="font-medium" style={{ color: colors.earthDark }}>No, I'm done</div>
                  <div className="text-xs text-gray-500 mt-1">
                    {firstResult === 'failed' ? 'Return home without wool' : 'Keep current deal'}
                  </div>
                </button>
              </div>
            );
          };

          const RevealTable = () => {
            // Get the actual deal that was made
            const hasAshaDeal = ashaState && typeof ashaState === 'object' && ashaState.rate;
            const hasMerenDeal = merenState && typeof merenState === 'object' && merenState.rate;
            const dealPartner = hasAshaDeal ? 'asha' : (hasMerenDeal ? 'meren' : null);
            const dealResult = hasAshaDeal ? ashaState : (hasMerenDeal ? merenState : null);
            
            // Calculate total rounds spent across all negotiations
            const getTotalRounds = () => {
              let total = 0;
              if (ashaState === 'pending' && ashaPendingOffer) total += ashaPendingOffer.rounds;
              else if (ashaState === 'declined') total += 3;
              else if (hasAshaDeal) total += ashaState.rounds;
              
              if (merenState === 'pending' && merenPendingOffer) total += merenPendingOffer.rounds;
              else if (merenState === 'declined') total += 3;
              else if (hasMerenDeal) total += merenState.rounds;
              
              return total || (dealResult ? dealResult.rounds : 0);
            };
            
            const totalRounds = getTotalRounds();
            const bestPossible = ASHA_FLOOR; // 4 mina
            const yourResult = dealResult ? dealResult.rate : 0;
            
            return (
              <div className="space-y-4">
                {/* Partner True Maximums Table */}
                <div className="overflow-x-auto">
                  <table className="w-full text-sm border-collapse">
                    <thead>
                      <tr className="border-b-2" style={{ borderColor: colors.earthLight }}>
                        <th className="text-left p-3" style={{ color: colors.earthDark }}>Partner</th>
                        <th className="text-left p-3" style={{ color: colors.earthDark }}>True Maximum</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr className="border-b" style={{ borderColor: colors.earthLight }}>
                        <td className="p-3 font-medium">Asha</td>
                        <td className="p-3">
                          <span className="inline-block px-3 py-1 rounded text-white font-bold text-sm" style={{ backgroundColor: '#22c55e' }}>4 mina</span>
                          <span className="text-gray-500 text-xs ml-2">(Best available)</span>
                        </td>
                      </tr>
                      <tr>
                        <td className="p-3 font-medium">Meren</td>
                        <td className="p-3">
                          <span className="inline-block px-3 py-1 rounded text-white font-bold text-sm" style={{ backgroundColor: '#f97316' }}>3 mina</span>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                
                {/* Your Result Card */}
                {dealResult && (
                  <div className="p-4 rounded-lg border" style={{ borderColor: colors.earthLight }}>
                    <h4 className="font-bold mb-2" style={{ color: colors.primary }}>Your Result</h4>
                    <p className="text-sm"><strong>Partner:</strong> {dealPartner === 'asha' ? 'Asha' : 'Meren'}</p>
                    <p className="text-sm"><strong>Wool received:</strong> {yourResult} mina</p>
                    <p className="text-sm"><strong>Total rounds:</strong> {totalRounds}</p>
                  </div>
                )}
                
                {/* Outcome Comparison Bar */}
                <div>
                  <h4 className="font-bold text-sm mb-2" style={{ color: colors.earthDark }}>Outcome Comparison</h4>
                  <div className="space-y-2">
                    <div className="flex items-center gap-3">
                      <span className="text-xs w-16 text-gray-600">Best:</span>
                      <div className="flex-1 h-6 rounded overflow-hidden bg-gray-100">
                        <div className="h-full rounded" style={{ width: '100%', backgroundColor: '#22c55e' }}></div>
                      </div>
                      <span className="text-sm font-bold w-16">{bestPossible} mina</span>
                    </div>
                    <div className="flex items-center gap-3">
                      <span className="text-xs w-16 text-gray-600">You got:</span>
                      <div className="flex-1 h-6 rounded overflow-hidden bg-gray-100">
                        <div className="h-full rounded" style={{ width: `${(yourResult / bestPossible) * 100}%`, backgroundColor: yourResult >= bestPossible ? '#22c55e' : '#f97316' }}></div>
                      </div>
                      <span className="text-sm font-bold w-16">{yourResult} mina</span>
                    </div>
                  </div>
                </div>
                
                {/* Rounds Spent */}
                <div>
                  <h4 className="font-bold text-sm mb-2" style={{ color: colors.earthDark }}>Rounds Spent</h4>
                  <div className="flex gap-1 mb-2">
                    {Array.from({ length: totalRounds }, (_, i) => (
                      <div key={i} className="w-8 h-8 rounded flex items-center justify-center text-white text-sm font-bold" style={{ backgroundColor: colors.primary }}>
                        {i + 1}
                      </div>
                    ))}
                  </div>
                  <p className="text-xs italic text-gray-600">With perfect information: 1 round. Walk to Asha, offer 4, done.</p>
                </div>
              </div>
            );
          };

          if (phase === 'intro') return (
            <div className="min-h-screen pb-20" style={{ background: `linear-gradient(to br, ${colors.sand}, #fff, ${colors.sand})` }}>
              <Header />
              <div className="p-4 max-w-2xl mx-auto">
                <div className="bg-white rounded-xl shadow-lg overflow-hidden border" style={{ borderColor: colors.earthLight }}>
                  <div className="p-5 text-white" style={{ background: `linear-gradient(to right, ${colors.primary}, #004080)` }}>
                    <h1 className="text-xl font-bold mb-1">Why We Start Here</h1>
                    <p className="text-blue-200 text-sm">From search to negotiation</p>
                  </div>
                  <div className="p-5 text-sm leading-relaxed">
                    <p className="text-gray-700 mb-3">
                      In Tutorial 1.1, you paid the cost of search. You traveled, you talked, you gathered information. Now you know <strong>WHO</strong> has wool and <strong>WHERE</strong> to find them.
                    </p>
                    <p className="text-gray-700 mb-3">
                      But you still don't know the most important thing: <strong>on what terms will they trade?</strong>
                    </p>
                    <p className="text-gray-700 mb-3">
                      This is a different information problem. In search, people freely shared what they have and wantâ€”the information helped everyone find matches. But in negotiation, people strategically conceal their true limits. Asha won't tell you the most she'd offer. Why would she? If you knew she'd give 4 mina of wool per sila of barley, you'd never accept 3.
                    </p>

                    <div className="my-4 p-4 rounded-lg border-l-4" style={{ backgroundColor: colors.sand, borderColor: colors.primary }}>
                      <p className="font-medium mb-2" style={{ color: colors.primary }}>Negotiation is an exchange of information.</p>
                      <p className="text-gray-600 text-xs">
                        Each offer you make, each response you receive, reveals something: "This is acceptable" or "This is not." But this information is costly to produceâ€”you can't just ask, you have to make offers and interpret responses, and the other party is actively working against you learning their true maximum.
                      </p>
                    </div>

                    <p className="text-gray-700 mb-4">
                      The goal isn't just to find <em>acceptable</em> terms. It's to find the <em>best</em> termsâ€”and you won't know what's possible until you negotiate.
                    </p>

                    <div className="p-4 rounded-lg text-center" style={{ backgroundColor: colors.sand }}>
                      <p className="font-medium" style={{ color: colors.earthDark }}>In this tutorial, you won't learn about negotiation costs.</p>
                      <p className="font-bold" style={{ color: colors.primary }}>You'll live them.</p>
                    </div>

                    <button onClick={() => { setPhase('tutorial'); window.scrollTo(0, 0); }} className="w-full mt-5 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2 hover:opacity-90" style={{ backgroundColor: colors.primary }}>
                      Continue <ChevronRight className="w-4 h-4" />
                    </button>
                  </div>
                </div>
              </div>
            </div>
          );

          if (phase === 'tutorial' && step === -1) return (
            <div className="min-h-screen pb-20" style={{ background: `linear-gradient(to br, ${colors.sand}, #fff, ${colors.sand})` }}>
              <Header />
              <div className="p-4 max-w-2xl mx-auto">
                <div className="bg-white rounded-xl shadow-lg overflow-hidden border" style={{ borderColor: colors.earthLight }}>
                  <div className="p-5" style={{ background: `linear-gradient(to right, ${colors.earth}, ${colors.earthDark})` }}>
                    <h1 className="text-xl font-bold text-white mb-1">The Negotiation Problem</h1>
                    <p className="text-sm" style={{ color: colors.earthLight }}>Producing information about terms</p>
                  </div>
                  <div className="p-5 text-sm">
                    <div className="mb-4 p-4 rounded-lg border-l-4 italic text-gray-700 text-sm" style={{ backgroundColor: colors.sand, borderColor: colors.accent }}>
                      <p>You return to the hills with a basket of barley. The morning is coldâ€”winter is coming, and your family needs wool.</p>
                      <p className="mt-2">Your search was successful. You found two potential partners: Asha and Meren. Both have wool. Both want barley.</p>
                      <p className="mt-2 font-medium not-italic" style={{ color: colors.earthDark }}>But here's what you don't know:</p>
                      <ul className="mt-1 not-italic text-gray-600 list-disc list-inside">
                        <li>How much wool will each offer for your barley?</li>
                        <li>What's the most each would give?</li>
                        <li>Which one will give you the better deal?</li>
                      </ul>
                      <p className="mt-2 not-italic text-gray-600">They're not going to tell you. You'll have to make offersâ€”and learn from their responses.</p>
                    </div>

                    <div className="mb-4">
                      <h3 className="font-bold text-sm mb-2" style={{ color: colors.earthDark }}>What You'll Discover</h3>
                      {[
                        "Negotiation produces information about acceptable terms",
                        "This information is costlyâ€”each round takes time and risks failure",
                        "Strategic concealment means you can't simply ask for someone's true limits",
                        "The \"value\" of your barley depends on who gives you the best terms"
                      ].map((t, i) => (
                        <div key={i} className="flex items-start gap-2 p-2 rounded border mb-1 text-xs" style={{ backgroundColor: '#f8f9fa', borderColor: colors.earthLight }}>
                          <span className="font-bold" style={{ color: colors.primary }}>{i+1}</span>
                          <span className="text-gray-700">{t}</span>
                        </div>
                      ))}
                    </div>

                    <div className="flex gap-2 mb-4 pt-3 border-t" style={{ borderColor: colors.earthLight }}>
                      <button onClick={() => setDevMode(!devMode)} className={`${devMode ? 'bg-purple-600 text-white' : 'bg-gray-200 text-gray-600'} px-3 py-1.5 rounded text-xs font-medium`}>
                        Dev: {devMode ? 'ON' : 'OFF'}
                      </button>
                      <button onClick={() => setShowGlossary(true)} className="px-3 py-1.5 rounded text-xs font-medium flex items-center gap-1" style={{ backgroundColor: colors.sand, color: colors.earthDark }}>
                        <Book className="w-3 h-3" /> Glossary
                      </button>
                      <span className="text-xs text-gray-500 ml-auto self-center">~10 min â€¢ 4 questions</span>
                    </div>

                    <button onClick={() => { setStep(0); window.scrollTo(0, 0); }} className="w-full text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2 hover:opacity-90" style={{ backgroundColor: colors.earth }}>
                      Begin Negotiation <ChevronRight className="w-4 h-4" />
                    </button>
                  </div>
                </div>
              </div>
              {showGlossary && <GlossaryModal terms={glossaryTerms} colors={colors} onClose={() => setShowGlossary(false)} />}
            </div>
          );

          if (phase === 'complete') return (
            <div className="min-h-screen pb-20" style={{ background: `linear-gradient(to br, ${colors.sand}, #fff, ${colors.sand})` }}>
              <Header />
              <div className="p-4 max-w-2xl mx-auto">
                <div className="bg-white rounded-xl shadow-lg overflow-hidden border" style={{ borderColor: colors.earthLight }}>
                  <div className="p-5 text-white text-center" style={{ background: 'linear-gradient(to right, #2d6a4f, #40916c)' }}>
                    <Trophy className="w-12 h-12 mx-auto mb-2 text-yellow-300" />
                    <h1 className="text-xl font-bold">Tutorial Complete!</h1>
                    <p className="text-green-100 text-sm">You've experienced the cost of producing information about terms</p>
                  </div>
                  <div className="p-5 text-sm">
                    <div className="mb-4 p-4 rounded-lg border-l-4" style={{ backgroundColor: '#f0f7ff', borderColor: colors.primary }}>
                      <h3 className="font-bold mb-2" style={{ color: colors.primary }}>What You Discovered</h3>
                      {[
                        ["Negotiation produces information about acceptable terms", "each offer and response reveals something"],
                        ["This information is costly to produce", "time, energy, and the risk of failure"],
                        ["Strategic concealment is the barrier", "neither party reveals their true limits"],
                        ["Value emerges from the best available exchange", "your barley is \"worth\" whatever gets you the most wool"]
                      ].map(([t, d], i) => (
                        <div key={i} className="flex items-start gap-2 mb-1 text-xs">
                          <CheckCircle className="w-4 h-4 text-green-600 flex-shrink-0" />
                          <div><strong>{t}</strong>â€”{d}</div>
                        </div>
                      ))}
                    </div>

                    <div className="mb-4 p-3 rounded-lg" style={{ backgroundColor: colors.sand }}>
                      <h3 className="font-bold text-xs mb-2" style={{ color: colors.earthDark }}>Your Negotiation Summary</h3>
                      <div className="overflow-x-auto">
                        <table className="w-full text-xs">
                          <thead>
                            <tr className="border-b" style={{ borderColor: colors.earthLight }}>
                              <th className="text-left p-1">Partner</th>
                              <th className="text-center p-1">Rounds</th>
                              <th className="text-center p-1">Outcome</th>
                              <th className="text-center p-1">Rate</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr className="border-b" style={{ borderColor: colors.earthLight }}>
                              <td className="p-1">Asha</td>
                              <td className="p-1 text-center">{!ashaResult || ashaResult === 'skipped' ? 'â€”' : ashaResult === 'failed' ? '3' : ashaResult.rounds}</td>
                              <td className="p-1 text-center">{!ashaResult || ashaResult === 'skipped' ? <span className="text-gray-400">Skipped</span> : ashaResult === 'failed' ? <span className="text-red-600">Failed</span> : <span className="text-green-600">Success</span>}</td>
                              <td className="p-1 text-center">{!ashaResult || ashaResult === 'skipped' || ashaResult === 'failed' ? 'â€”' : ashaResult.rate + ' mina/sila'}</td>
                            </tr>
                            <tr>
                              <td className="p-1">Meren</td>
                              <td className="p-1 text-center">{!merenResult || merenResult === 'skipped' ? 'â€”' : merenResult === 'failed' ? '3' : merenResult.rounds}</td>
                              <td className="p-1 text-center">{!merenResult || merenResult === 'skipped' ? <span className="text-gray-400">Skipped</span> : merenResult === 'failed' ? <span className="text-red-600">Failed</span> : <span className="text-green-600">Success</span>}</td>
                              <td className="p-1 text-center">{!merenResult || merenResult === 'skipped' || merenResult === 'failed' ? 'â€”' : merenResult.rate + ' mina/sila'}</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>

                      <div className="mt-3 pt-3 border-t" style={{ borderColor: colors.earthLight }}>
                        <p className="text-xs" style={{ color: colors.earthDark }}>
                          <strong>Best possible:</strong> Asha at 4 mina/sila
                        </p>
                      </div>
                    </div>

                    <div className="mb-4 p-4 rounded-lg border" style={{ backgroundColor: '#f8f9fa', borderColor: colors.earthLight }}>
                      <p className="font-bold text-xs mb-2" style={{ color: colors.primary }}>Bridge to Tutorial 1.3</p>
                      <p className="text-gray-700 text-xs mb-2">
                        You've now experienced both search costs (finding partners) and negotiation costs (finding terms).
                      </p>
                      <p className="text-gray-700 text-xs mb-2">
                        Each was an information problem. Each was costly. And you only dealt with two potential partners.
                      </p>
                      <p className="text-gray-700 text-xs">
                        What if there were dozens? What if you could see all their offers at once, compare them instantly, and trade with whoever offers the best terms? That's what a market does.
                      </p>
                    </div>

                    <div className="mb-4 p-4 rounded-lg border" style={{ backgroundColor: '#f8f9fa', borderColor: colors.earthLight }}>
                      <p className="font-bold text-xs mb-1" style={{ color: colors.earthDark }}>Next: Tutorial 1.3 â€” The Market Solution</p>
                      <p className="text-gray-700 text-xs">
                        Search and negotiation were costly. Markets are the solutionâ€”concentrating traders and making information visible. You'll see how markets reduce transaction costs by solving the information problems you've just experienced.
                      </p>
                    </div>

                    <div className="flex gap-2">
                      <button onClick={handleRestart} className="flex-1 text-white font-bold py-3 rounded-lg hover:opacity-90" style={{ backgroundColor: colors.primary }}>
                        Restart
                      </button>
                      <a href="tutorial-1-3.html" className="flex-1 text-center font-bold py-3 rounded-lg hover:opacity-90" style={{ backgroundColor: colors.earth, color: 'white' }}>
                        Next Tutorial â†’
                      </a>
                    </div>
                  </div>
                </div>
              </div>
              {showGlossary && <GlossaryModal terms={glossaryTerms} colors={colors} onClose={() => setShowGlossary(false)} />}
            </div>
          );

          const q = questions.find(q => q.id === step);
          if (!q) return null;

          const narrative = q.type === 'choice' ? getChoiceNarrative() : q.narrative;
          const question = q.type === 'choice' ? getChoiceQuestion() : q.question;

          return (
            <div className="min-h-screen pb-20" style={{ background: `linear-gradient(to br, ${colors.sand}, #fff, ${colors.sand})` }}>
              <Header />
              <div className="p-4 max-w-2xl mx-auto">
                <div className="bg-white rounded-xl shadow-lg overflow-hidden border" style={{ borderColor: colors.earthLight }}>
                  <div className="p-3 border-b flex items-center justify-between" style={{ borderColor: colors.earthLight, backgroundColor: '#f8f9fa' }}>
                    <span className="text-xs font-medium text-gray-600">Question {step <= 1 ? step + 1 : step - 1} of 4</span>
                    <div className="flex gap-1">
                      {[0,1,4,5].map((qId, i) => (
                        <div key={qId} className={`w-6 h-1.5 rounded ${qId < step ? 'bg-green-500' : qId === step ? 'bg-blue-500' : 'bg-gray-200'}`} style={qId === step ? { backgroundColor: colors.primary } : {}} />
                      ))}
                    </div>
                    <div className="flex items-center gap-2">
                      {devMode && <button onClick={nextStep} className="text-xs bg-purple-600 text-white px-2 py-1 rounded">Skip</button>}
                      <button onClick={handleRestart} className="text-xs text-white hover:text-gray-200 flex items-center gap-1" title="Restart tutorial">
                        <RefreshCw className="w-5 h-5" />
                        <span>Restart</span>
                      </button>
                    </div>
                  </div>

                  <div className="p-5">
                    {narrative && (
                      <div className="mb-4 p-4 rounded-lg border-l-4 italic text-gray-700 text-sm whitespace-pre-line" style={{ backgroundColor: colors.sand, borderColor: colors.accent }}>
                        {narrative}
                      </div>
                    )}

                    {q.type === 'reveal' && !showExplanation && <RevealTable />}

                    <div className="mb-4">
                      <p className="font-medium text-sm mb-3 whitespace-pre-line" style={{ color: colors.earthDark }}>{question}</p>

                      {(q.type === 'negotiation1' || q.type === 'negotiation2') && !showExplanation && (
                        <div className="mb-4">
                          {negotiationPhase === 'select' ? (
                            <PartnerSelector onSelect={handleSelectPartner} />
                          ) : (
                            <NegotiationInterface />
                          )}
                        </div>
                      )}

                      {q.type === 'choice' && !showExplanation && (
                        <div className="mb-4">
                          <ChoiceInterface />
                        </div>
                      )}

                      {!showExplanation && q.type !== 'negotiation1' && q.type !== 'negotiation2' && q.type !== 'choice' && (
                        <div className="space-y-3">
                          <textarea
                            value={answer}
                            onChange={(e) => setAnswer(e.target.value)}
                            className="w-full p-3 border rounded-lg text-sm focus:outline-none focus:ring-2"
                            style={{ borderColor: colors.earthLight }}
                            rows={2}
                            placeholder="Your answer..."
                          />

                          {hintIndex > 0 && (
                            <div className="p-3 rounded-lg text-xs" style={{ backgroundColor: '#fff7ed', borderLeft: `3px solid ${colors.accent}` }}>
                              {q.hints.slice(0, hintIndex).map((h, i) => (
                                <p key={i} className="mb-1 last:mb-0">ðŸ’¡ {h}</p>
                              ))}
                            </div>
                          )}

                          {showIncorrectFeedback && (
                            <div className="p-3 rounded-lg border-l-4" style={{ backgroundColor: '#fef3c7', borderColor: '#f59e0b' }}>
                              <p className="text-amber-800 text-sm">Not quite. Try again! ({3 - attemptCount} attempt{3 - attemptCount !== 1 ? 's' : ''} remaining)</p>
                            </div>
                          )}

                          <div className="flex gap-2">
                            {hintIndex < q.hints.length && (
                              <button
                                onClick={() => setHintIndex(hintIndex + 1)}
                                className="px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-1"
                                style={{ backgroundColor: colors.sand, color: colors.earthDark }}
                              >
                                <HelpCircle className="w-4 h-4" /> Hint
                              </button>
                            )}
                            <button
                              onClick={handleSubmit}
                              disabled={!answer.trim()}
                              className="flex-1 text-white py-2 rounded-lg text-sm font-medium disabled:opacity-50"
                              style={{ backgroundColor: colors.primary }}
                            >
                              Submit
                            </button>
                          </div>
                        </div>
                      )}

                      {!showExplanation && (q.type === 'negotiation1' || q.type === 'negotiation2') && negotiationPhase === 'failed' && (
                        <div className="mt-4">
                          <button
                            onClick={() => setShowExplanation(true)}
                            className="w-full text-white py-2 rounded-lg text-sm font-medium"
                            style={{ backgroundColor: colors.primary }}
                          >
                            Continue
                          </button>
                        </div>
                      )}

                      {!showExplanation && q.type === 'choice' && wantsSecondNegotiation !== null && (
                        <div className="mt-4">
                          <button
                            onClick={() => setShowExplanation(true)}
                            className="w-full text-white py-2 rounded-lg text-sm font-medium"
                            style={{ backgroundColor: colors.primary }}
                          >
                            Continue
                          </button>
                        </div>
                      )}

                      {!showExplanation && (q.type === 'negotiation1' || q.type === 'negotiation2') && negotiationPhase === 'offer' && (
                        <div className="mt-4">
                          {hintIndex > 0 && (
                            <div className="p-3 rounded-lg text-xs mb-3" style={{ backgroundColor: '#fff7ed', borderLeft: `3px solid ${colors.accent}` }}>
                              {q.hints.slice(0, hintIndex).map((h, i) => (
                                <p key={i} className="mb-1 last:mb-0">ðŸ’¡ {h}</p>
                              ))}
                            </div>
                          )}
                          {hintIndex < q.hints.length && (
                            <button
                              onClick={() => setHintIndex(hintIndex + 1)}
                              className="px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-1"
                              style={{ backgroundColor: colors.sand, color: colors.earthDark }}
                            >
                              <HelpCircle className="w-4 h-4" /> Hint
                            </button>
                          )}
                        </div>
                      )}

                      {showExplanation && (
                        <div className="space-y-4">
                          <div className="p-4 rounded-lg border-l-4" style={{
                            backgroundColor: (attemptCount >= 3 && q.type !== 'negotiation1' && q.type !== 'negotiation2' && q.type !== 'choice') ? '#fef3c7' : '#f0fff4',
                            borderColor: (attemptCount >= 3 && q.type !== 'negotiation1' && q.type !== 'negotiation2' && q.type !== 'choice') ? '#f59e0b' : '#22c55e'
                          }}>
                            <p className={`font-bold text-sm mb-2 ${(attemptCount >= 3 && q.type !== 'negotiation1' && q.type !== 'negotiation2' && q.type !== 'choice') ? 'text-amber-800' : 'text-green-800'}`}>
                              {(attemptCount >= 3 && q.type !== 'negotiation1' && q.type !== 'negotiation2' && q.type !== 'choice')
                                ? "Here's what we were looking for:"
                                : `âœ“ ${q.type === 'choice' ? 'Choice Made' : (q.type === 'negotiation1' || q.type === 'negotiation2') ? (negotiationPhase === 'complete' ? 'Negotiation Complete' : 'Negotiation Ended') : 'Correct!'}`}
                            </p>
                            <p className="text-gray-700 text-sm">{renderMarkdown(getExplanation())}</p>
                          </div>
                          <button
                            onClick={nextStep}
                            className="w-full text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2 hover:opacity-90"
                            style={{ backgroundColor: colors.primary }}
                          >
                            Continue <ChevronRight className="w-4 h-4" />
                          </button>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              </div>
              {showGlossary && <GlossaryModal terms={glossaryTerms} colors={colors} onClose={() => setShowGlossary(false)} />}
            </div>
          );
        };

        // Render
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Tutorial12 />);
    </script>

    <!-- Navigation Footer -->
    <div style="position: fixed; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,53,107,0.95), rgba(0,53,107,0.85)); backdrop-filter: blur(8px); border-top: 1px solid rgba(255,255,255,0.1); padding: 12px 16px; z-index: 40;">
        <div style="max-width: 42rem; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; gap: 12px;">
            <a href="tutorial-1-1.html" style="flex: 1; padding: 10px 16px; background: rgba(255,255,255,0.1); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 14px; text-align: center; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                <span style="display: flex; align-items: center; gap: 4px;"><span style="font-size: 16px;">â†</span> Previous</span>
                <span style="font-size: 11px; opacity: 0.8;">Tutorial 1.1</span>
            </a>
            <a href="../index.html" style="flex: 1; padding: 10px 16px; background: rgba(201,162,39,0.9); color: white; text-decoration: none; border-radius: 8px; font-weight: 700; font-size: 14px; text-align: center; transition: all 0.2s;" onmouseover="this.style.background='rgba(201,162,39,1)'" onmouseout="this.style.background='rgba(201,162,39,0.9)'">
                Hub
            </a>
            <a href="tutorial-1-3.html" style="flex: 1; padding: 10px 16px; background: rgba(255,255,255,0.1); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 14px; text-align: center; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                <span style="display: flex; align-items: center; gap: 4px;">Next <span style="font-size: 16px;">â†’</span></span>
                <span style="font-size: 11px; opacity: 0.8;">Tutorial 1.3</span>
            </a>
        </div>
    </div>
</body>
</html>
