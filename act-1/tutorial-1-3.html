<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutorial 1.3: The Marketplace Emerges - Accounting Origins</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Inline SVG icon components
        const ChevronRight = ({ className = "w-6 h-6", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2} {...props}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M9 5l7 7-7 7" />
            </svg>
        );

        const Clock = ({ className = "w-6 h-6", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2} {...props}>
                <circle cx="12" cy="12" r="10" />
                <path strokeLinecap="round" strokeLinejoin="round" d="M12 6v6l4 2" />
            </svg>
        );

        const Users = ({ className = "w-6 h-6", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2} {...props}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
        );

        const CheckCircle = ({ className = "w-6 h-6", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2} {...props}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        );

        const HelpCircle = ({ className = "w-6 h-6", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2} {...props}>
                <circle cx="12" cy="12" r="10" />
                <path strokeLinecap="round" strokeLinejoin="round" d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3m.08 4h.01" />
            </svg>
        );

        const Book = ({ className = "w-6 h-6", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2} {...props}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M4 19.5A2.5 2.5 0 016.5 17H20M4 19.5A2.5 2.5 0 016.5 22H20V2H6.5A2.5 2.5 0 004 4.5v15z" />
            </svg>
        );

        const Trophy = ({ className = "w-6 h-6", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2} {...props}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
            </svg>
        );

        const Volume2 = ({ className = "w-6 h-6", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2} {...props}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M11 5L6 9H2v6h4l5 4V5zm8.07 2.93a10 10 0 010 14.14M15.54 9.46a5 5 0 010 7.07" />
            </svg>
        );

        const VolumeX = ({ className = "w-6 h-6", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2} {...props}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M11 5L6 9H2v6h4l5 4V5zm12 4l-6 6m0-6l6 6" />
            </svg>
        );

        const Store = ({ className = "w-6 h-6", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2} {...props}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                <path strokeLinecap="round" strokeLinejoin="round" d="M9 22V12h6v10" />
            </svg>
        );

        const Eye = ({ className = "w-6 h-6", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2} {...props}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                <circle cx="12" cy="12" r="3" />
            </svg>
        );

        const ArrowRight = ({ className = "w-6 h-6", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2} {...props}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M5 12h14m-7-7l7 7-7 7" />
            </svg>
        );

        const RefreshCw = ({ className = "w-6 h-6", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2} {...props}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M1 4v6h6M23 20v-6h-6" />
                <path strokeLinecap="round" strokeLinejoin="round" d="M20.49 9A9 9 0 005.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 013.51 15" />
            </svg>
        );

        const ArrowLeft = ({ className = "w-6 h-6", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2} {...props}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M19 12H5m7 7l-7-7 7-7" />
            </svg>
        );

        const Home = ({ className = "w-6 h-6", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2} {...props}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                <path strokeLinecap="round" strokeLinejoin="round" d="M9 22V12h6v10" />
            </svg>
        );

        // Inline SVG icons
        const MarketIcon = () => <svg viewBox="0 0 24 24" className="w-6 h-6" fill="currentColor"><path d="M12 2L2 7v2h20V7L12 2zm0 3l6 3H6l6-3zM2 22h20v-2H2v2zm2-3h4v-7H4v7zm6 0h4v-7h-4v7zm6 0h4v-7h-4v7z"/></svg>;
        const WoolIcon = () => <svg viewBox="0 0 24 24" className="w-5 h-5" fill="currentColor"><circle cx="8" cy="8" r="3"/><circle cx="16" cy="8" r="3"/><circle cx="12" cy="14" r="3"/><circle cx="6" cy="16" r="2"/><circle cx="18" cy="16" r="2"/><circle cx="12" cy="20" r="2"/></svg>;

        // Simple markdown renderer for explanations
        const renderMarkdown = (text) => {
          if (!text) return null;

          // Split by newlines to handle paragraphs and bullet points
          const lines = text.split('\n');
          const elements = [];
          let key = 0;

          for (let i = 0; i < lines.length; i++) {
            let line = lines[i];

            // Handle bullet points (• at start of line)
            if (line.trim().startsWith('•')) {
              const bulletContent = line.trim().substring(1).trim();
              elements.push(
                <div key={key++} className="flex items-start gap-2 ml-2 my-1">
                  <span className="text-gray-500">•</span>
                  <span>{renderInlineMarkdown(bulletContent)}</span>
                </div>
              );
            }
            // Handle empty lines as spacing
            else if (line.trim() === '') {
              elements.push(<div key={key++} className="h-2" />);
            }
            // Regular paragraph
            else {
              elements.push(
                <p key={key++} className="my-1">{renderInlineMarkdown(line)}</p>
              );
            }
          }

          return <>{elements}</>;
        };

        // Handle inline markdown (bold, italic)
        const renderInlineMarkdown = (text) => {
          if (!text) return null;

          // Process **bold** and *italic*
          const parts = [];
          let remaining = text;
          let key = 0;

          while (remaining.length > 0) {
            // Look for **bold**
            const boldMatch = remaining.match(/\*\*(.+?)\*\*/);
            // Look for *italic* (but not **)
            const italicMatch = remaining.match(/(?<!\*)\*([^*]+)\*(?!\*)/);

            // Find which comes first
            let firstMatch = null;
            let matchType = null;

            if (boldMatch && (!italicMatch || boldMatch.index <= italicMatch.index)) {
              firstMatch = boldMatch;
              matchType = 'bold';
            } else if (italicMatch) {
              firstMatch = italicMatch;
              matchType = 'italic';
            }

            if (firstMatch) {
              // Add text before match
              if (firstMatch.index > 0) {
                parts.push(<span key={key++}>{remaining.substring(0, firstMatch.index)}</span>);
              }
              // Add formatted text
              if (matchType === 'bold') {
                parts.push(<strong key={key++}>{firstMatch[1]}</strong>);
              } else {
                parts.push(<em key={key++}>{firstMatch[1]}</em>);
              }
              remaining = remaining.substring(firstMatch.index + firstMatch[0].length);
            } else {
              // No more matches, add rest of text
              parts.push(<span key={key++}>{remaining}</span>);
              break;
            }
          }

          return parts.length > 0 ? <>{parts}</> : text;
        };

        const Tutorial13 = () => {
          const [phase, setPhase] = useState('intro'); // intro, tutorial, complete
          const [step, setStep] = useState(-1); // -1 = welcome, 0-4 = questions, 'observe' = observation phase
          const [answer, setAnswer] = useState('');
          const [showExplanation, setShowExplanation] = useState(false);
          const [hintIndex, setHintIndex] = useState(0);
          const [showGlossary, setShowGlossary] = useState(false);
          const [devMode, setDevMode] = useState(false);
          const [attemptCount, setAttemptCount] = useState(0);
          const [showIncorrectFeedback, setShowIncorrectFeedback] = useState(false);

          // Sound state
          const [soundEnabled, setSoundEnabled] = useState(false);
          const [availableVoices, setAvailableVoices] = useState([]);

          // Observation state
          const [observationIndex, setObservationIndex] = useState(-1);
          const [observedTrades, setObservedTrades] = useState([]);
          const [isObserving, setIsObserving] = useState(false);

          // Negotiation interruption state
          const [initialOffer, setInitialOffer] = useState('');
          const [showInterruption, setShowInterruption] = useState(false);

          // Trade selection
          const [selectedTrader, setSelectedTrader] = useState(null);

          // Prior tutorial data
          const [priorData, setPriorData] = useState(null);

          const observationTimerRef = useRef(null);

          // Restart handler - resets all state
          const handleRestart = () => {
            setPhase('intro');
            setStep(-1);
            setAnswer('');
            setShowExplanation(false);
            setHintIndex(0);
            setAttemptCount(0);
            setShowIncorrectFeedback(false);
            setSoundEnabled(false);
            setObservationIndex(-1);
            setObservedTrades([]);
            setIsObserving(false);
            setInitialOffer('');
            setShowInterruption(false);
            setSelectedTrader(null);
            if (observationTimerRef.current) {
              clearTimeout(observationTimerRef.current);
            }
            window.scrollTo(0, 0);
          };

          const colors = {
            primary: '#00356b',
            sand: '#f5f1e8',
            earth: '#8b7355',
            earthLight: '#d4c4a8',
            earthDark: '#5c4d3d',
            accent: '#c9a227'
          };

          // The 12 traders at market
          const allTraders = [
            { id: 'asha', name: 'Asha', has: 'wool', wants: 'barley', rate: 4, known: true, description: 'The patient shepherd from the hills' },
            { id: 'meren', name: 'Meren', has: 'wool', wants: 'barley', rate: 3, known: true, description: 'The younger shepherd, eager to trade' },
            { id: 'haran', name: 'Haran', has: 'wool', wants: 'barley', rate: 3, known: false, description: 'A wool seller you don\'t recognize' },
            { id: 'suri', name: 'Suri', has: 'wool', wants: 'barley', rate: 5, known: false, description: 'A woman with thick bundles of wool' },
            { id: 'ravi', name: 'Ravi', has: 'pottery', wants: 'fish', rate: null, known: false, description: 'Potter from the clay beds' },
            { id: 'yara', name: 'Yara', has: 'fish', wants: 'pottery', rate: null, known: false, description: 'Fisher from the river camps' },
            { id: 'jorak', name: 'Jorak', has: 'tools', wants: 'cloth', rate: null, known: false, description: 'Toolmaker from the forest' },
            { id: 'kesh', name: 'Kesh', has: 'cloth', wants: 'tools', rate: null, known: false, description: 'Weaver with bolts of fabric' },
            { id: 'tam', name: 'Tam', has: 'honey', wants: 'salt', rate: null, known: false, description: 'Beekeeper from the river bend' },
            { id: 'nara', name: 'Nara', has: 'salt', wants: 'honey', rate: null, known: false, description: 'Salt gatherer from the flats' },
            { id: 'dara', name: 'Dara', has: 'baskets', wants: 'grain', rate: null, known: false, description: 'Basket weaver' },
            { id: 'omar', name: 'Omar', has: 'grain', wants: 'baskets', rate: null, known: false, description: 'Farmer with sacks of grain' },
          ];

          // Wool sellers for selection
          const woolSellers = allTraders.filter(t => t.has === 'wool');

          // The 5 observable trades
          const marketTrades = [
            { seller: 'Trader', text: 'Three mina wool for one sila barley!', rate: 3, good: 'wool', completed: true },
            { seller: 'Asha', text: 'Four mina wool for one sila! Good weight, good quality!', rate: 4, good: 'wool', completed: true },
            { seller: 'Yara', text: 'Three fish for one pot! Fresh catch!', rate: 3, good: 'fish', completed: true },
            { seller: 'Haran', text: 'Three mina per sila! Three mina!', rate: 3, good: 'wool', completed: true },
            { seller: 'Suri', text: 'Five mina wool per sila! Five mina!', rate: 5, good: 'wool', completed: false, available: true },
          ];

          const glossaryTerms = [
            { term: 'Market', definition: 'A gathering where traders meet, dramatically reducing the cost of finding partners and learning exchange terms.' },
            { term: 'Price Discovery', definition: 'The process by which observable trades reveal what things are "worth"—rates cluster as information spreads.' },
            { term: 'Called Offer', definition: 'A publicly announced willingness to trade at specific terms—before writing, the original "price."' },
            { term: 'Going Rate', definition: 'The typical exchange rate for a good, emerging from the clustering of observed trades.' },
            { term: 'Comparison', definition: 'The ability to see multiple offers before committing—only possible when terms are visible.' },
          ];

          // Load voices for speech synthesis
          useEffect(() => {
            if (typeof window !== 'undefined' && window.speechSynthesis) {
              const loadVoices = () => {
                const voices = window.speechSynthesis.getVoices();
                setAvailableVoices(voices);
              };
              loadVoices();
              window.speechSynthesis.onvoiceschanged = loadVoices;
            }

            // Try to load prior tutorial data
            try {
              const stored = localStorage.getItem('tutorial12Results');
              if (stored) {
                setPriorData(JSON.parse(stored));
              }
            } catch (e) {
              console.log('No prior tutorial data found');
            }

            return () => {
              if (window.speechSynthesis) {
                window.speechSynthesis.cancel();
              }
              if (observationTimerRef.current) {
                clearTimeout(observationTimerRef.current);
              }
            };
          }, []);

          // Speak text aloud
          const speak = (text, traderName = null) => {
            if (!soundEnabled || !window.speechSynthesis) return;

            window.speechSynthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(text);

            if (traderName && availableVoices.length > 0) {
              const charCode = traderName.charCodeAt(0);
              utterance.pitch = 0.8 + (charCode % 5) * 0.15;
              utterance.rate = 0.9 + (traderName.length % 3) * 0.1;
              utterance.voice = availableVoices[charCode % availableVoices.length];
            } else {
              utterance.rate = 0.95;
              utterance.pitch = 1;
            }

            window.speechSynthesis.speak(utterance);
          };

          // Run observation sequence
          const runObservation = async () => {
            setIsObserving(true);
            setObservedTrades([]);
            setObservationIndex(-1);

            for (let i = 0; i < marketTrades.length; i++) {
              setObservationIndex(i);

              // Speak the call
              speak(marketTrades[i].text, marketTrades[i].seller);

              // Wait for display
              await new Promise(resolve => {
                observationTimerRef.current = setTimeout(resolve, 3500);
              });

              // Add to observed list
              setObservedTrades(prev => [...prev, marketTrades[i]]);

              // Brief pause
              await new Promise(resolve => {
                observationTimerRef.current = setTimeout(resolve, 500);
              });
            }

            setObservationIndex(-1);
            setIsObserving(false);
          };

          // Save results to localStorage for future tutorials
          const saveResults = () => {
            try {
              const results = {
                selectedTrader: selectedTrader,
                rateAchieved: woolSellers.find(t => t.id === selectedTrader)?.rate,
                priorBest: priorData?.ashaResult?.rate || 4,
                timestamp: Date.now()
              };
              localStorage.setItem('tutorial13Results', JSON.stringify(results));
            } catch (e) {
              console.log('Could not save results');
            }
          };

          const questions = [
            {
              id: 0,
              type: 'prediction',
              narrative: "You've walked this valley before. You know what it takes to find a trading partner: hours of travel, conversation after conversation, piecing together who has what and wants what.\n\nToday, the traders come to you.",
              question: "How do you expect finding a wool seller at the gathering to compare with your search in Tutorial 1.1? Will it take more time, less time, or about the same?",
              hints: ["Think about why you had to travel so much before...", "If everyone who wants to trade is in one place..."],
              evaluate: (a) => {
                const lower = a.toLowerCase();
                return lower.includes('less') || lower.includes('faster') || lower.includes('easier') || lower.includes('quicker');
              },
              answer: "Less time",
              explanation: "When traders gather, you don't have to walk the valley to find them. The information about \"who is willing to trade\" is concentrated in one place. That's the first benefit: **search costs drop dramatically** when everyone shows up.\n\nBut that's just the beginning. Let's see what else changes."
            },
            {
              id: 1,
              type: 'negotiate',
              narrative: "You arrive at the river crossing. The sight stops you cold.\n\nDozens of people. More than you've ever seen trading at once. Wool sellers, potters, fishers, tool-makers—all here, all looking for trades.\n\nYou spot a man with bundles of wool. You approach, just like you did with Asha and Meren in the hills.",
              question: "You approach Haran, a wool seller.\n\n\"I have barley,\" you say. \"Good grain, dry and clean.\"\n\nHe looks at your basket. \"How much wool do you want for it?\"\n\nMake your opening offer (mina of wool per sila of barley):",
              hints: ["This is how you negotiated in the hills...", "Enter a number for how much wool you want per sila."],
              evaluate: (a) => showInterruption,
              answer: "Any offer triggers interruption",
              explanation: "" // Dynamic
            },
            {
              id: 2,
              type: 'pattern',
              narrative: "You've been watching for perhaps an hour. Trades happening around you, offers being called.\n\nIn Tutorial 1.2, you negotiated blind—you had no idea what Asha or Meren would accept until you made offers and watched their reactions.\n\nHere, you can see the information before you commit.",
              question: "Based on what you observed, what is the typical exchange rate for wool? And what is the best rate currently available?",
              hints: ["Look at the trades that happened: 3, 4, 3...", "One offer is still open—and it's higher than the others."],
              evaluate: (a) => {
                const lower = a.toLowerCase();
                const hasTypical = lower.includes('3') || lower.includes('4') || lower.includes('three') || lower.includes('four');
                const hasBest = lower.includes('5') || lower.includes('five') || lower.includes('suri');
                return hasTypical && hasBest;
              },
              answer: "Typical: 3-4 mina/sila. Best available: 5 mina/sila (Suri)",
              explanation: "The trades you watched clustered around 3-4 mina per sila. That's emerging as the \"going rate\" for wool in this market.\n\nBut Suri is offering 5—better than anything else you've seen. Better than Asha's 4 from the hills. And you learned this **by watching**, not by negotiating with every seller one by one."
            },
            {
              id: 3,
              type: 'choose',
              narrative: "You know the options now. You've seen the rates. You can compare before committing—something that was impossible when you negotiated alone in the hills.",
              question: "Who do you want to trade with?",
              hints: ["You can see all the offers...", "Who gives you the most wool per sila?"],
              evaluate: (a) => selectedTrader !== null,
              answer: "Select a trader",
              explanation: "" // Dynamic based on selection
            },
            {
              id: 4,
              type: 'contrast',
              narrative: "You walk home with your wool—more than you expected to get.\n\nThink back to your experience in the hills (Tutorial 1.2).",
              question: "How was finding and making a trade at the market different from your negotiations in the hills?",
              hints: ["Think about what you knew before trading in each case...", "Think about how much effort it took to find partners...", "Think about whether you had to guess at acceptable terms..."],
              evaluate: (a) => a.length > 30,
              answer: "Substantive comparison",
              explanation: "" // Dynamic
            },
            {
              id: 5,
              type: 'insight',
              narrative: "In Tutorial 1.1, you asked: who has wool? Where are they?\n\nIn Tutorial 1.2, you asked: what terms will they accept?\n\nBoth required costly information production—traveling, talking, negotiating.\n\nToday, you got answers to both questions by showing up and watching.",
              question: "What is your barley \"worth\"? How do you know?",
              hints: ["What was the best rate available to you?", "How did you learn that rate existed?"],
              evaluate: (a) => {
                const lower = a.toLowerCase();
                return (lower.includes('5') || lower.includes('five') || lower.includes('suri')) &&
                       (lower.includes('watch') || lower.includes('market') || lower.includes('observ') || lower.includes('saw') || lower.includes('heard'));
              },
              answer: "5 mina/sila — learned by watching the market",
              explanation: "Your barley is worth **5 mina of wool per sila**—because that's the best exchange rate available to you.\n\nIn Tutorial 1.2, you thought your barley was worth 4 mina/sila. That was the best you could find through costly search and negotiation. But the market revealed something better—not because it created value that didn't exist, but because it made information about existing options **cheaper to gather**.\n\n**Value isn't something your goods have. It's something that emerges when people trade—and becomes visible when those trades are observable.**\n\nThe market didn't change what your barley could become. It reduced the cost of discovering your options."
            }
          ];

          // Handle submitting initial offer (triggers interruption)
          const handleOfferSubmit = () => {
            const offer = parseInt(initialOffer);
            if (isNaN(offer) || offer < 1) return;
            setShowInterruption(true);
            speak("Three mina wool for one sila barley!", "Voice1");
          };

          const handleSubmit = () => {
            const q = questions.find(q => q.id === step);
            if (q && q.evaluate(answer)) {
              setShowExplanation(true);
              setShowIncorrectFeedback(false);
            } else {
              const newAttemptCount = attemptCount + 1;
              setAttemptCount(newAttemptCount);
              if (newAttemptCount >= 3) {
                setShowExplanation(true); // Show answer after 3 tries
                setShowIncorrectFeedback(false);
              } else {
                setShowIncorrectFeedback(true);
              }
            }
          };

          const nextStep = () => {
            setAnswer('');
            setShowExplanation(false);
            setHintIndex(0);
            setAttemptCount(0);
            setShowIncorrectFeedback(false);

            if (step === 1) {
              // After interrupted negotiation, go to observation
              setStep('observe');
            } else if (step === 'observe') {
              // After observation, go to pattern question
              setStep(2);
            } else if (step < 5) {
              setStep(step + 1);
            } else {
              saveResults();
              setPhase('complete');
            }
            window.scrollTo(0, 0);
          };

          const prevStep = () => {
            setAnswer('');
            setShowExplanation(false);
            setHintIndex(0);
            setAttemptCount(0);
            setShowIncorrectFeedback(false);

            if (step === 2) {
              // From pattern question, go back to observation
              setStep('observe');
            } else if (step === 'observe') {
              // From observation, go back to interrupted negotiation
              setStep(1);
              setShowInterruption(true);
            } else if (step === 0) {
              // From first question, go back to welcome
              setStep(-1);
            } else if (step > 0) {
              setStep(step - 1);
            } else {
              setPhase('intro');
            }
            window.scrollTo(0, 0);
          };

          const getExplanation = () => {
            const q = questions.find(q => q.id === step);
            if (!q) return '';

            if (q.type === 'negotiate') {
              return `Before Haran can respond, voices cut through from nearby:\n\n**"Three mina wool for one sila barley!"**\n**"Four mina! Four mina wool per sila!"**\n\nHaran looks over his shoulder at the shouting, then back at you. His expression has changed—he's wondering if he should match those offers, or if you've already heard them.\n\nYou realize: **everyone here can hear what everyone else is offering.**\n\nIn isolated trading, negotiation happens in private. Here, traders call out their terms to attract partners—and everyone within earshot learns what rates are available.\n\nLet's step back and watch how this market works.`;
            }

            if (q.type === 'choose') {
              const trader = woolSellers.find(t => t.id === selectedTrader);
              if (!trader) return '';

              if (trader.id === 'suri') {
                return `You approach Suri. "Five mina per sila?" She nods. You hand over your barley. She counts out the wool.\n\n**5 mina per sila.** Better than Asha's 4. Better than you thought was possible when you left home this morning.\n\nAnd you didn't have to negotiate for it. You didn't have to walk for half a day. You just **watched** and **compared**.`;
              } else if (trader.id === 'asha') {
                return `You approach Asha—a familiar face from the hills. "Four mina per sila?" She nods, recognizing you. The trade is done.\n\nYou got a good rate. But you might have noticed Suri offering 5 mina per sila at the edge of the crowd. At a market, better options can appear from unexpected places. The information was there to find.`;
              } else {
                return `You complete the trade at ${trader.rate} mina per sila.\n\nThat's a fair rate—it's what most wool was trading for today. But others were offering more: Asha at 4, and Suri at 5. One advantage of a market is that you can compare before committing. The information was available; using it is up to you.`;
              }
            }

            if (q.type === 'contrast') {
              let explanation = "In the hills, you walked for half a day just to find partners. Then you negotiated blind—each offer was a guess, each response a clue. You thought Asha's 4 was the best available because she was the best you could find.\n\nAt the market:\n";
              explanation += "• **Search:** Partners were already there. No walking the valley.\n";
              explanation += "• **Information:** Competing sellers called out terms to attract you.\n";
              explanation += "• **Comparison:** You could see all offers before committing.\n";
              explanation += "• **Discovery:** You found Suri—someone offering 5 mina/sila—without even looking for her.\n\n";
              explanation += "The market didn't eliminate the work of trading. But it made gathering information **dramatically cheaper**. What took days now took hours. What required negotiation now required only listening.";
              return explanation;
            }

            return q.explanation;
          };

          // Glossary Modal
          const GlossaryModal = () => (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
              <div className="bg-white rounded-xl max-w-lg w-full max-h-[80vh] overflow-y-auto">
                <div className="p-4 border-b flex justify-between items-center" style={{ borderColor: colors.earthLight }}>
                  <h2 className="font-bold text-lg" style={{ color: colors.primary }}>Glossary</h2>
                  <button onClick={() => setShowGlossary(false)} className="text-gray-500 hover:text-gray-700 text-xl">×</button>
                </div>
                <div className="p-4">
                  {glossaryTerms.map((t, i) => (
                    <div key={i} className="mb-4 last:mb-0">
                      <h3 className="font-bold text-sm" style={{ color: colors.earthDark }}>{t.term}</h3>
                      <p className="text-gray-600 text-sm">{t.definition}</p>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          );

          // Header component
          const Header = () => (
            <div className="p-3 text-white flex items-center justify-between" style={{ backgroundColor: colors.primary }}>
              <div className="flex items-center gap-2">
                <MarketIcon />
                <span className="font-bold">Tutorial 1.3</span>
              </div>
              <div className="flex items-center gap-3">
                <button
                  onClick={() => setSoundEnabled(!soundEnabled)}
                  className={`p-1.5 rounded ${soundEnabled ? 'bg-white/20' : 'bg-white/10'}`}
                  title={soundEnabled ? 'Sound on' : 'Sound off'}
                >
                  {soundEnabled ? <Volume2 className="w-4 h-4" /> : <VolumeX className="w-4 h-4" />}
                </button>
                <button
                  onClick={handleRestart}
                  className="p-1.5 rounded bg-white/10 hover:bg-white/20"
                  title="Restart tutorial"
                >
                  <RefreshCw className="w-5 h-5 text-white" />
                </button>
                <div className="flex items-center gap-1 text-xs">
                  <Clock className="w-4 h-4" />
                  <span>~12 min</span>
                </div>
              </div>
            </div>
          );

          // Trader avatar component
          const TraderAvatar = ({ trader, size = 'md', showRate = false, selected = false, onClick = null }) => {
            const sizeClasses = {
              sm: 'w-8 h-8 text-xs',
              md: 'w-10 h-10 text-sm',
              lg: 'w-12 h-12 text-base'
            };

            const bgColor = trader.known ? colors.earth : colors.earthDark;

            return (
              <div
                className={`flex flex-col items-center ${onClick ? 'cursor-pointer' : ''}`}
                onClick={onClick}
              >
                <div
                  className={`${sizeClasses[size]} rounded-full flex items-center justify-center text-white font-bold ${selected ? 'ring-4 ring-green-500' : ''}`}
                  style={{ backgroundColor: bgColor }}
                >
                  {trader.name[0]}
                </div>
                {showRate && trader.rate && (
                  <span className="text-xs font-bold mt-1" style={{ color: trader.rate === 5 ? '#16a34a' : colors.primary }}>
                    {trader.rate}
                  </span>
                )}
              </div>
            );
          };

          // Trade card for observation
          const TradeCard = ({ trade, isActive, index }) => (
            <div
              className={`p-3 rounded-lg border-l-4 transition-all ${isActive ? 'bg-amber-100 border-amber-500' : 'bg-white border-gray-200'}`}
            >
              <div className="flex items-center gap-2 mb-1">
                <div
                  className="w-7 h-7 rounded-full flex items-center justify-center text-white text-xs font-bold"
                  style={{ backgroundColor: colors.earth }}
                >
                  {trade.seller[0]}
                </div>
                <span className="font-medium text-sm" style={{ color: colors.earthDark }}>{trade.seller}</span>
                {isActive && <span className="ml-auto text-xs px-2 py-0.5 bg-amber-200 rounded animate-pulse">Calling...</span>}
                {!isActive && trade.completed && <span className="ml-auto text-xs text-gray-400">✓ Traded</span>}
                {!isActive && trade.available && <span className="ml-auto text-xs text-green-600 font-medium">Available!</span>}
              </div>
              <p className="text-gray-700 text-sm italic">"{trade.text}"</p>
              <p className="text-xs mt-1">
                <span className="font-bold" style={{ color: trade.rate === 5 ? '#16a34a' : colors.primary }}>
                  {trade.rate} {trade.good === 'wool' ? 'mina/sila' : 'fish/pot'}
                </span>
                <span className="text-gray-400 ml-2">({trade.good})</span>
              </p>
            </div>
          );

          // Wool seller selection cards
          const WoolSellerCard = ({ trader, selected, onSelect }) => (
            <button
              onClick={() => onSelect(trader.id)}
              className={`w-full p-3 rounded-lg border-2 text-left transition-all ${
                selected ? 'border-green-500 bg-green-50' : 'border-gray-200 hover:border-blue-300 hover:bg-blue-50'
              }`}
            >
              <div className="flex items-center gap-3">
                <TraderAvatar trader={trader} size="md" />
                <div className="flex-1">
                  <div className="flex items-center gap-2">
                    <span className="font-bold" style={{ color: colors.earthDark }}>{trader.name}</span>
                    {trader.known && <span className="text-xs text-gray-400">(you know them)</span>}
                  </div>
                  <p className="text-xs text-gray-500">{trader.description}</p>
                </div>
                <div className="text-right">
                  <p className="font-bold text-lg" style={{ color: trader.rate === 5 ? '#16a34a' : colors.primary }}>
                    {trader.rate}
                  </p>
                  <p className="text-xs text-gray-500">mina/sila</p>
                </div>
              </div>
            </button>
          );

          // Comparison table for completion
          const ComparisonTable = () => (
            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead>
                  <tr className="border-b-2" style={{ borderColor: colors.earthLight }}>
                    <th className="text-left p-2"></th>
                    <th className="text-center p-2" style={{ color: colors.earthDark }}>Tutorial 1.1-1.2</th>
                    <th className="text-center p-2" style={{ color: colors.earthDark }}>Tutorial 1.3</th>
                  </tr>
                </thead>
                <tbody className="text-xs">
                  <tr className="border-b" style={{ borderColor: colors.earthLight }}>
                    <td className="p-2 font-medium">Finding partners</td>
                    <td className="p-2 text-center text-gray-600">Walk the valley (hours)</td>
                    <td className="p-2 text-center text-green-700">Everyone present</td>
                  </tr>
                  <tr className="border-b" style={{ borderColor: colors.earthLight }}>
                    <td className="p-2 font-medium">Learning terms</td>
                    <td className="p-2 text-center text-gray-600">Negotiate blind</td>
                    <td className="p-2 text-center text-green-700">Hear offers called</td>
                  </tr>
                  <tr className="border-b" style={{ borderColor: colors.earthLight }}>
                    <td className="p-2 font-medium">Best rate found</td>
                    <td className="p-2 text-center text-gray-600">{priorData?.ashaResult?.rate || 4} mina/sila</td>
                    <td className="p-2 text-center text-green-700 font-bold">5 mina/sila</td>
                  </tr>
                  <tr>
                    <td className="p-2 font-medium">How discovered</td>
                    <td className="p-2 text-center text-gray-600">Costly negotiation</td>
                    <td className="p-2 text-center text-green-700">Passive observation</td>
                  </tr>
                </tbody>
              </table>
            </div>
          );


          // INTRO SCREEN
          if (phase === 'intro') return (
            <div className="min-h-screen pb-20" style={{ background: `linear-gradient(to br, ${colors.sand}, #fff, ${colors.sand})` }}>
              <Header />
              <div className="p-4 max-w-2xl mx-auto pb-20">
                <div className="bg-white rounded-xl shadow-lg overflow-hidden border" style={{ borderColor: colors.earthLight }}>
                  <div className="p-5 text-white" style={{ background: `linear-gradient(to right, ${colors.primary}, #004080)` }}>
                    <h1 className="text-xl font-bold mb-1">Why We Start Here</h1>
                    <p className="text-blue-200 text-sm">When traders gather, information flows</p>
                  </div>
                  <div className="p-5 text-sm leading-relaxed">
                    <p className="text-gray-700 mb-3">
                      In Tutorial 1.1, you paid the cost of <strong>search</strong>—walking the valley, talking to people one by one, piecing together who might trade with you.
                    </p>
                    <p className="text-gray-700 mb-3">
                      In Tutorial 1.2, you paid the cost of <strong>negotiation</strong>—making offers, watching responses, never quite knowing what terms were actually possible.
                    </p>
                    <p className="text-gray-700 mb-3">
                      Both were information problems. Both were costly. And you only dealt with a handful of potential partners.
                    </p>

                    <div className="my-4 p-4 rounded-lg border-l-4" style={{ backgroundColor: colors.sand, borderColor: colors.primary }}>
                      <p className="font-medium mb-2" style={{ color: colors.primary }}>What if traders gathered in one place?</p>
                      <p className="text-gray-600 text-xs">
                        What if you didn't have to walk the valley? What if you could hear what others were willing to offer—without negotiating with each one individually? What if you could compare before committing?
                      </p>
                    </div>

                    <p className="text-gray-700 mb-4">
                      Word has spread through the valley: on the next full moon, traders will meet at the river crossing. No one organized it—people just started saying "I'll be there." The problem of scattered information is creating its own solution.
                    </p>

                    <div className="p-4 rounded-lg text-center" style={{ backgroundColor: colors.sand }}>
                      <p className="font-medium" style={{ color: colors.earthDark }}>In this tutorial, you'll experience</p>
                      <p className="font-bold" style={{ color: colors.primary }}>how markets reduce the cost of gathering information.</p>
                    </div>

                    <button onClick={() => { setPhase('tutorial'); window.scrollTo(0, 0); }} className="w-full mt-5 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2 hover:opacity-90" style={{ backgroundColor: colors.primary }}>
                      Continue <ChevronRight className="w-4 h-4" />
                    </button>
                  </div>
                </div>
              </div>
            </div>
          );

          // WELCOME SCREEN
          if (phase === 'tutorial' && step === -1) return (
            <div className="min-h-screen pb-20" style={{ background: `linear-gradient(to br, ${colors.sand}, #fff, ${colors.sand})` }}>
              <Header />
              <div className="p-4 max-w-2xl mx-auto pb-20">
                <div className="bg-white rounded-xl shadow-lg overflow-hidden border" style={{ borderColor: colors.earthLight }}>
                  <div className="p-5" style={{ background: `linear-gradient(to right, ${colors.earth}, ${colors.earthDark})` }}>
                    <h1 className="text-xl font-bold text-white mb-1">The Marketplace Emerges</h1>
                    <p className="text-sm" style={{ color: colors.earthLight }}>When traders gather, information flows</p>
                  </div>
                  <div className="p-5 text-sm">
                    <div className="mb-4 p-4 rounded-lg border-l-4 italic text-gray-700 text-sm" style={{ backgroundColor: colors.sand, borderColor: colors.accent }}>
                      <p>The sun rises over the river crossing. You've never seen so many people here—traders from every corner of the valley, their goods spread before them.</p>
                      <p className="mt-2">Your family still needs wool. You have barley to trade.</p>
                      <p className="mt-2 font-medium not-italic" style={{ color: colors.earthDark }}>But this time, you won't have to walk the valley to find partners.</p>
                    </div>

                    {/* Trader avatars preview */}
                    <div className="mb-4 p-3 rounded-lg" style={{ backgroundColor: '#f0f7ff' }}>
                      <p className="text-xs font-medium mb-2" style={{ color: colors.primary }}>Traders at the gathering:</p>
                      <div className="flex flex-wrap gap-2">
                        {allTraders.slice(0, 8).map(trader => (
                          <TraderAvatar key={trader.id} trader={trader} size="sm" />
                        ))}
                        <div className="w-8 h-8 rounded-full flex items-center justify-center bg-gray-200 text-gray-500 text-xs">
                          +4
                        </div>
                      </div>
                    </div>

                    <div className="mb-4">
                      <h3 className="font-bold text-sm mb-2" style={{ color: colors.earthDark }}>What You'll Discover</h3>
                      {[
                        "Search costs drop when traders gather",
                        "Called offers make terms visible without negotiation",
                        "Observable trades reveal what things are \"worth\"",
                        "You can compare before committing"
                      ].map((t, i) => (
                        <div key={i} className="flex items-start gap-2 p-2 rounded border mb-1 text-xs" style={{ backgroundColor: '#f8f9fa', borderColor: colors.earthLight }}>
                          <span className="font-bold" style={{ color: colors.primary }}>{i+1}</span>
                          <span className="text-gray-700">{t}</span>
                        </div>
                      ))}
                    </div>

                    <div className="flex gap-2 mb-4 pt-3 border-t" style={{ borderColor: colors.earthLight }}>
                      <button onClick={() => setDevMode(!devMode)} className={`${devMode ? 'bg-purple-600 text-white' : 'bg-gray-200 text-gray-600'} px-3 py-1.5 rounded text-xs font-medium`}>
                        Dev: {devMode ? 'ON' : 'OFF'}
                      </button>
                      <button onClick={() => setShowGlossary(true)} className="px-3 py-1.5 rounded text-xs font-medium flex items-center gap-1" style={{ backgroundColor: colors.sand, color: colors.earthDark }}>
                        <Book className="w-3 h-3" /> Glossary
                      </button>
                      <span className="text-xs text-gray-500 ml-auto self-center">~12 min • 6 questions</span>
                    </div>

                    <div className="flex gap-2">
                      <button onClick={prevStep} className="flex-1 py-3 rounded-lg text-sm font-medium" style={{ backgroundColor: colors.sand, color: colors.earthDark }}>
                        ← Back
                      </button>
                      <button onClick={() => { setStep(0); window.scrollTo(0, 0); }} className="flex-1 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2 hover:opacity-90" style={{ backgroundColor: colors.earth }}>
                        Enter the Market <ChevronRight className="w-4 h-4" />
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              {showGlossary && <GlossaryModal />}
            </div>
          );

          // OBSERVATION PHASE
          if (phase === 'tutorial' && step === 'observe') return (
            <div className="min-h-screen pb-20" style={{ background: `linear-gradient(to br, ${colors.sand}, #fff, ${colors.sand})` }}>
              <Header />
              <div className="p-4 max-w-2xl mx-auto pb-20">
                <div className="bg-white rounded-xl shadow-lg overflow-hidden border" style={{ borderColor: colors.earthLight }}>
                  <div className="p-3 border-b flex items-center justify-between" style={{ borderColor: colors.earthLight, backgroundColor: '#f8f9fa' }}>
                    <div className="flex items-center gap-2">
                      <Eye className="w-4 h-4" style={{ color: colors.primary }} />
                      <span className="text-sm font-medium" style={{ color: colors.primary }}>Observation Phase</span>
                    </div>
                    {devMode && <button onClick={nextStep} className="text-xs bg-purple-600 text-white px-2 py-1 rounded">Skip</button>}
                  </div>

                  <div className="p-5">
                    <div className="mb-4 p-4 rounded-lg border-l-4 italic text-gray-700 text-sm" style={{ backgroundColor: colors.sand, borderColor: colors.accent }}>
                      <p>You step back from Haran. Around you, the market unfolds.</p>
                      <p className="mt-2 font-medium not-italic" style={{ color: colors.earthDark }}>You watch. You listen.</p>
                    </div>

                    {!isObserving && observedTrades.length === 0 && (
                      <div className="text-center py-8">
                        <Store className="w-12 h-12 mx-auto mb-3" style={{ color: colors.earth }} />
                        <p className="text-gray-600 mb-4">Watch the market in action.</p>
                        <button
                          onClick={runObservation}
                          className="px-6 py-3 rounded-lg text-white font-medium flex items-center gap-2 mx-auto"
                          style={{ backgroundColor: colors.primary }}
                        >
                          <Eye className="w-4 h-4" /> Begin Observation
                        </button>
                        {soundEnabled && (
                          <p className="text-xs text-gray-500 mt-2">You'll hear traders call out their offers</p>
                        )}
                      </div>
                    )}

                    {(isObserving || observedTrades.length > 0) && (
                      <div className="space-y-3">
                        {/* Current trade being called */}
                        {isObserving && observationIndex >= 0 && (
                          <TradeCard
                            trade={marketTrades[observationIndex]}
                            isActive={true}
                            index={observationIndex}
                          />
                        )}

                        {/* Observed trades log */}
                        {observedTrades.length > 0 && (
                          <div className="border rounded-lg overflow-hidden" style={{ borderColor: colors.earthLight }}>
                            <div className="p-2 flex items-center gap-2" style={{ backgroundColor: colors.sand }}>
                              <Users className="w-4 h-4" style={{ color: colors.earth }} />
                              <span className="font-medium text-xs" style={{ color: colors.earthDark }}>
                                Trades Observed ({observedTrades.length})
                              </span>
                            </div>
                            <div className="divide-y" style={{ borderColor: colors.earthLight }}>
                              {observedTrades.map((trade, i) => (
                                <div key={i} className="p-2 flex items-center justify-between">
                                  <div className="flex items-center gap-2">
                                    <div
                                      className="w-6 h-6 rounded-full flex items-center justify-center text-white text-xs font-bold"
                                      style={{ backgroundColor: colors.earth }}
                                    >
                                      {trade.seller[0]}
                                    </div>
                                    <span className="text-xs font-medium">{trade.seller}</span>
                                  </div>
                                  <div className="flex items-center gap-2">
                                    <span className="text-xs font-bold" style={{ color: trade.rate === 5 ? '#16a34a' : colors.primary }}>
                                      {trade.rate} {trade.good === 'wool' ? 'mina/sila' : 'fish/pot'}
                                    </span>
                                    {trade.available && <span className="text-xs text-green-600">✓ Open</span>}
                                  </div>
                                </div>
                              ))}
                            </div>
                          </div>
                        )}

                        {/* Summary after observation complete */}
                        {!isObserving && observedTrades.length === marketTrades.length && (
                          <div className="mt-4 p-4 rounded-lg border" style={{ backgroundColor: '#f0fff4', borderColor: '#86efac' }}>
                            <h3 className="font-bold text-sm mb-2 text-green-800">What You Learned</h3>
                            <div className="text-xs text-green-700 space-y-1">
                              <p>• Wool-for-barley rates: <strong>3, 4, 3, 5</strong> mina per sila</p>
                              <p>• Most trades clustered at <strong>3-4</strong> (the "going rate")</p>
                              <p>• Best offer still available: <strong>Suri at 5 mina/sila</strong></p>
                            </div>
                            <p className="text-xs text-green-600 mt-2 italic">
                              You didn't negotiate with anyone. You didn't even speak. But now you know what wool is trading for.
                            </p>

                            <div className="flex gap-2 mt-4">
                              <button
                                onClick={prevStep}
                                className="flex-1 py-2 rounded-lg text-sm font-medium"
                                style={{ backgroundColor: colors.sand, color: colors.earthDark }}
                              >
                                ← Back
                              </button>
                              <button
                                onClick={nextStep}
                                className="flex-1 text-white font-bold py-2 rounded-lg flex items-center justify-center gap-2"
                                style={{ backgroundColor: colors.primary }}
                              >
                                Continue <ChevronRight className="w-4 h-4" />
                              </button>
                            </div>
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                </div>
              </div>
              {showGlossary && <GlossaryModal />}
            </div>
          );

          // COMPLETE SCREEN
          if (phase === 'complete') {
            const finalTrader = woolSellers.find(t => t.id === selectedTrader);

            return (
              <div className="min-h-screen pb-20" style={{ background: `linear-gradient(to br, ${colors.sand}, #fff, ${colors.sand})` }}>
                <Header />
                <div className="p-4 max-w-2xl mx-auto pb-20">
                  <div className="bg-white rounded-xl shadow-lg overflow-hidden border" style={{ borderColor: colors.earthLight }}>
                    <div className="p-5 text-white text-center" style={{ background: 'linear-gradient(to right, #2d6a4f, #40916c)' }}>
                      <Trophy className="w-12 h-12 mx-auto mb-2 text-yellow-300" />
                      <h1 className="text-xl font-bold">Tutorial Complete!</h1>
                      <p className="text-green-100 text-sm">You've experienced how markets reduce the cost of gathering information</p>
                    </div>
                    <div className="p-5 text-sm">
                      <div className="mb-4 p-4 rounded-lg border-l-4" style={{ backgroundColor: '#f0f7ff', borderColor: colors.primary }}>
                        <h3 className="font-bold mb-2" style={{ color: colors.primary }}>What You Discovered</h3>
                        {[
                          ["Search costs drop", "when traders gather—no more walking the valley"],
                          ["Calling out makes terms visible", "no more negotiating blind"],
                          ["Prices emerge from trades", "the clustering around 3-4 mina/sila"],
                          ["Comparison before commitment", "you could see all offers at once"],
                          ["Markets reveal options", "Suri's 5 was better than anything from the hills"]
                        ].map(([t, d], i) => (
                          <div key={i} className="flex items-start gap-2 mb-1 text-xs">
                            <CheckCircle className="w-4 h-4 text-green-600 flex-shrink-0" />
                            <div><strong>{t}</strong>—{d}</div>
                          </div>
                        ))}
                      </div>

                      {/* Your trade summary */}
                      <div className="mb-4 p-3 rounded-lg" style={{ backgroundColor: colors.sand }}>
                        <h3 className="font-bold text-xs mb-2" style={{ color: colors.earthDark }}>Your Trade</h3>
                        <div className="flex items-center gap-3">
                          <TraderAvatar trader={finalTrader} size="md" />
                          <div>
                            <p className="font-medium" style={{ color: colors.earthDark }}>{finalTrader?.name}</p>
                            <p className="text-xs text-gray-500">{finalTrader?.description}</p>
                          </div>
                          <div className="ml-auto text-right">
                            <p className="font-bold text-lg" style={{ color: finalTrader?.rate === 5 ? '#16a34a' : colors.primary }}>
                              {finalTrader?.rate} mina/sila
                            </p>
                          </div>
                        </div>
                      </div>

                      {/* Comparison table */}
                      <div className="mb-4">
                        <h3 className="font-bold text-xs mb-2" style={{ color: colors.earthDark }}>The Difference</h3>
                        <ComparisonTable />
                      </div>

                      {/* Bridge to 1.4 */}
                      <div className="mb-4 p-4 rounded-lg border" style={{ backgroundColor: '#f8f9fa', borderColor: colors.earthLight }}>
                        <p className="font-bold text-xs mb-1" style={{ color: colors.primary }}>Bridge to Tutorial 1.4</p>
                        <p className="text-gray-700 text-xs mb-2">
                          The market made your wool-for-barley trade easy. Terms visible, best rate found, deal done.
                        </p>
                        <p className="text-gray-700 text-xs mb-2">
                          But look around. Fish trading for pottery. Tools for cloth. Honey for salt. Dozens of goods, dozens of exchange rates.
                        </p>
                        <p className="text-gray-700 text-xs">
                          How do you compare? What if there were one good that everyone accepted—a common measure?
                        </p>
                      </div>

                      <div className="flex gap-2">
                        <button
                          onClick={() => { setPhase('tutorial'); setStep(5); window.scrollTo(0, 0); }}
                          className="flex-1 py-3 rounded-lg text-sm font-medium"
                          style={{ backgroundColor: colors.sand, color: colors.earthDark }}
                        >
                          ← Back
                        </button>
                        <button
                          onClick={handleRestart}
                          className="flex-1 text-white font-bold py-3 rounded-lg hover:opacity-90"
                          style={{ backgroundColor: colors.primary }}
                        >
                          Restart Tutorial
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
                {showGlossary && <GlossaryModal />}
                </div>
            );
          }

          // MAIN TUTORIAL - Questions
          const q = questions.find(q => q.id === step);
          if (!q) return null;

          return (
            <div className="min-h-screen pb-20" style={{ background: `linear-gradient(to br, ${colors.sand}, #fff, ${colors.sand})` }}>
              <Header />
              <div className="p-4 max-w-2xl mx-auto pb-20">
                <div className="bg-white rounded-xl shadow-lg overflow-hidden border" style={{ borderColor: colors.earthLight }}>
                  {/* Progress */}
                  <div className="p-3 border-b flex items-center justify-between" style={{ borderColor: colors.earthLight, backgroundColor: '#f8f9fa' }}>
                    <span className="text-xs font-medium text-gray-600">Question {step + 1} of 6</span>
                    <div className="flex gap-1">
                      {[0,1,2,3,4,5].map(i => (
                        <div
                          key={i}
                          className={`w-6 h-1.5 rounded ${i < step ? 'bg-green-500' : i === step ? '' : 'bg-gray-200'}`}
                          style={i === step ? { backgroundColor: colors.primary } : {}}
                        />
                      ))}
                    </div>
                    <div className="flex items-center gap-2">
                      {devMode && <button onClick={nextStep} className="text-xs bg-purple-600 text-white px-2 py-1 rounded">Skip</button>}
                      <button onClick={handleRestart} className="text-white hover:opacity-80 flex items-center gap-1" title="Restart tutorial">
                        <RefreshCw className="w-5 h-5" />
                      </button>
                    </div>
                  </div>

                  <div className="p-5">
                    {/* Narrative */}
                    <div className="mb-4 p-4 rounded-lg border-l-4 italic text-gray-700 text-sm whitespace-pre-line" style={{ backgroundColor: colors.sand, borderColor: colors.accent }}>
                      {q.narrative}
                    </div>

                    {/* Question */}
                    <div className="mb-4">
                      <p className="font-medium text-sm mb-3 whitespace-pre-line" style={{ color: colors.earthDark }}>{q.question}</p>

                      {/* Negotiation interface for Q1 */}
                      {q.type === 'negotiate' && !showExplanation && (
                        <div className="mb-4">
                          {!showInterruption ? (
                            <div className="p-4 rounded-lg border" style={{ borderColor: colors.earthLight }}>
                              <div className="flex items-center gap-2 mb-3">
                                <div className="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold" style={{ backgroundColor: colors.earthDark }}>H</div>
                                <div>
                                  <p className="font-medium" style={{ color: colors.earthDark }}>Haran</p>
                                  <p className="text-xs text-gray-500">Wool seller</p>
                                </div>
                              </div>
                              <div className="flex items-center gap-2">
                                <span className="text-sm text-gray-600">I want</span>
                                <input
                                  type="number"
                                  min="1"
                                  max="20"
                                  value={initialOffer}
                                  onChange={(e) => setInitialOffer(e.target.value)}
                                  className="w-16 p-2 border rounded text-center font-bold"
                                  style={{ borderColor: colors.earthLight }}
                                  placeholder="?"
                                />
                                <span className="text-sm text-gray-600">mina of wool per sila of barley.</span>
                              </div>
                              <button
                                onClick={handleOfferSubmit}
                                disabled={!initialOffer || parseInt(initialOffer) < 1}
                                className="mt-3 w-full text-white py-2 rounded-lg text-sm font-medium disabled:opacity-50"
                                style={{ backgroundColor: colors.primary }}
                              >
                                Make Offer
                              </button>
                            </div>
                          ) : (
                            <div className="space-y-3">
                              <div className="p-3 rounded-lg bg-amber-50 border-l-4 border-amber-500">
                                <p className="text-sm text-amber-800 font-medium mb-1">Before Haran can respond...</p>
                                <p className="text-amber-700 italic">"Three mina wool for one sila barley!"</p>
                              </div>
                              <div className="p-3 rounded-lg bg-amber-50 border-l-4 border-amber-500">
                                <p className="text-amber-700 italic">"Four mina! Four mina wool per sila!"</p>
                              </div>
                              <div className="p-3 rounded-lg" style={{ backgroundColor: colors.sand }}>
                                <p className="text-sm text-gray-700">
                                  Haran looks over his shoulder at the shouting, then back at you. His expression has changed.
                                </p>
                              </div>
                            </div>
                          )}
                        </div>
                      )}

                      {/* Trader selection for Q3 */}
                      {q.type === 'choose' && !showExplanation && (
                        <div className="space-y-2 mb-4">
                          {woolSellers.map(trader => (
                            <WoolSellerCard
                              key={trader.id}
                              trader={trader}
                              selected={selectedTrader === trader.id}
                              onSelect={setSelectedTrader}
                            />
                          ))}
                        </div>
                      )}

                      {/* Prior data display for Q4 */}
                      {q.type === 'contrast' && !showExplanation && priorData && (
                        <div className="mb-4 p-3 rounded-lg" style={{ backgroundColor: '#f0f7ff' }}>
                          <p className="text-xs font-medium mb-2" style={{ color: colors.primary }}>Your Tutorial 1.2 Results:</p>
                          <div className="text-xs text-gray-600">
                            <p>• Asha offered: {priorData.ashaResult?.rate || 4} mina/sila</p>
                            <p>• Meren offered: {priorData.merenResult?.rate || 3} mina/sila</p>
                          </div>
                        </div>
                      )}

                      {/* Standard answer input - not for choose or negotiate types */}
                      {!showExplanation && q.type !== 'choose' && q.type !== 'negotiate' && (
                        <div className="space-y-3">
                          <textarea
                            value={answer}
                            onChange={(e) => setAnswer(e.target.value)}
                            className="w-full p-3 border rounded-lg text-sm focus:outline-none focus:ring-2"
                            style={{ borderColor: colors.earthLight }}
                            rows={2}
                            placeholder="Your answer..."
                          />

                          {/* Hints */}
                          {hintIndex > 0 && (
                            <div className="p-3 rounded-lg text-xs" style={{ backgroundColor: '#fff7ed', borderLeft: `3px solid ${colors.accent}` }}>
                              {q.hints.slice(0, hintIndex).map((h, i) => (
                                <p key={i} className="mb-1 last:mb-0">💡 {h}</p>
                              ))}
                            </div>
                          )}

                          {/* Incorrect feedback */}
                          {showIncorrectFeedback && (
                            <div className="p-3 rounded-lg border-l-4" style={{ backgroundColor: '#fef3c7', borderColor: '#f59e0b' }}>
                              <p className="text-amber-800 text-sm">Not quite. Try again! ({3 - attemptCount} attempt{3 - attemptCount !== 1 ? 's' : ''} remaining)</p>
                            </div>
                          )}

                          <div className="flex gap-2">
                            <button
                              onClick={prevStep}
                              className="px-4 py-2 rounded-lg text-sm font-medium"
                              style={{ backgroundColor: colors.sand, color: colors.earthDark }}
                            >
                              ← Back
                            </button>
                            {hintIndex < q.hints.length && (
                              <button
                                onClick={() => setHintIndex(hintIndex + 1)}
                                className="px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-1"
                                style={{ backgroundColor: colors.sand, color: colors.earthDark }}
                              >
                                <HelpCircle className="w-4 h-4" /> Hint
                              </button>
                            )}
                            <button
                              onClick={handleSubmit}
                              disabled={!answer.trim() && q.type !== 'negotiate'}
                              className="flex-1 text-white py-2 rounded-lg text-sm font-medium disabled:opacity-50"
                              style={{ backgroundColor: colors.primary }}
                            >
                              Submit
                            </button>
                          </div>
                        </div>
                      )}

                      {/* Submit for negotiate after interruption */}
                      {q.type === 'negotiate' && showInterruption && !showExplanation && (
                        <div className="flex gap-2 mt-4">
                          <button
                            onClick={prevStep}
                            className="flex-1 py-2 rounded-lg text-sm font-medium"
                            style={{ backgroundColor: colors.sand, color: colors.earthDark }}
                          >
                            ← Back
                          </button>
                          <button
                            onClick={() => setShowExplanation(true)}
                            className="flex-1 text-white py-2 rounded-lg text-sm font-medium"
                            style={{ backgroundColor: colors.primary }}
                          >
                            Continue
                          </button>
                        </div>
                      )}

                      {/* Submit for choose */}
                      {q.type === 'choose' && selectedTrader && !showExplanation && (
                        <div className="flex gap-2">
                          <button
                            onClick={prevStep}
                            className="flex-1 py-2 rounded-lg text-sm font-medium"
                            style={{ backgroundColor: colors.sand, color: colors.earthDark }}
                          >
                            ← Back
                          </button>
                          <button
                            onClick={() => setShowExplanation(true)}
                            className="flex-1 text-white py-2 rounded-lg text-sm font-medium"
                            style={{ backgroundColor: colors.primary }}
                          >
                            Confirm Trade with {woolSellers.find(t => t.id === selectedTrader)?.name}
                          </button>
                        </div>
                      )}

                      {/* Explanation */}
                      {showExplanation && (
                        <div className="space-y-4">
                          <div className="p-4 rounded-lg border-l-4" style={{
                            backgroundColor: q.type === 'prediction' ? '#fffbeb' : ((attemptCount >= 3 && q.type !== 'choose' && q.type !== 'negotiate') ? '#fef3c7' : '#f0fff4'),
                            borderColor: q.type === 'prediction' ? '#f59e0b' : ((attemptCount >= 3 && q.type !== 'choose' && q.type !== 'negotiate') ? '#f59e0b' : '#22c55e')
                          }}>
                            <p className="font-bold text-sm mb-2" style={{
                              color: q.type === 'prediction' ? '#92400e' : ((attemptCount >= 3 && q.type !== 'choose' && q.type !== 'negotiate') ? '#92400e' : '#166534')
                            }}>
                              {q.type === 'prediction'
                                ? "Let's see..."
                                : ((attemptCount >= 3 && q.type !== 'choose' && q.type !== 'negotiate')
                                  ? "Here's what we were looking for:"
                                  : `✓ ${q.type === 'choose' ? 'Trade Complete!' : 'Correct!'}`)}
                            </p>
                            <p className="text-gray-700 text-sm">{renderMarkdown(getExplanation())}</p>
                          </div>
                          <div className="flex gap-2">
                            <button
                              onClick={prevStep}
                              className="flex-1 py-3 rounded-lg text-sm font-medium"
                              style={{ backgroundColor: colors.sand, color: colors.earthDark }}
                            >
                              ← Back
                            </button>
                            <button
                              onClick={nextStep}
                              className="flex-1 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2 hover:opacity-90"
                              style={{ backgroundColor: colors.primary }}
                            >
                              Continue <ChevronRight className="w-4 h-4" />
                            </button>
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              </div>
              {showGlossary && <GlossaryModal />}
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Tutorial13 />);
    </script>

    <!-- Navigation Footer -->
    <div style="position: fixed; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,53,107,0.95), rgba(0,53,107,0.85)); backdrop-filter: blur(8px); border-top: 1px solid rgba(255,255,255,0.1); padding: 12px 16px; z-index: 40;">
        <div style="max-width: 42rem; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; gap: 12px;">
            <a href="tutorial-1-2.html" style="flex: 1; padding: 10px 16px; background: rgba(255,255,255,0.1); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 14px; text-align: center; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                <span style="display: flex; align-items: center; gap: 4px;"><span style="font-size: 16px;">←</span> Previous</span>
                <span style="font-size: 11px; opacity: 0.8;">Tutorial 1.2</span>
            </a>
            <a href="../index.html" style="flex: 1; padding: 10px 16px; background: rgba(201,162,39,0.9); color: white; text-decoration: none; border-radius: 8px; font-weight: 700; font-size: 14px; text-align: center; transition: all 0.2s;" onmouseover="this.style.background='rgba(201,162,39,1)'" onmouseout="this.style.background='rgba(201,162,39,0.9)'">
                Hub
            </a>
            <a href="tutorial-1-4.html" style="flex: 1; padding: 10px 16px; background: rgba(255,255,255,0.1); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 14px; text-align: center; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                <span style="display: flex; align-items: center; gap: 4px;">Next <span style="font-size: 16px;">→</span></span>
                <span style="font-size: 11px; opacity: 0.8;">Tutorial 1.4</span>
            </a>
        </div>
    </div>
</body>
</html>