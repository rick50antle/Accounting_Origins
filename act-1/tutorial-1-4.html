<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tutorial 1.4: The Common Standard | Accounting Origins</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400&family=Source+Sans+Pro:wght@400;600;700&display=swap');
    
    body {
      font-family: 'Source Sans Pro', sans-serif;
      margin: 0;
      padding: 0;
    }
    
    .font-serif {
      font-family: 'Crimson Text', serif;
    }
    
    .narrative-text {
      font-family: 'Crimson Text', serif;
      font-style: italic;
      line-height: 1.7;
    }
    
    /* Smooth transitions */
    .fade-in {
      animation: fadeIn 0.4s ease-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Trade animation */
    .trade-step {
      animation: slideIn 0.5s ease-out forwards;
      opacity: 0;
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    /* Input focus styles */
    input:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(0, 53, 107, 0.2);
    }
    
    /* Button hover effects */
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 53, 107, 0.3);
    }
    
    .btn-primary:active {
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    /**
     * Tutorial 1.4: The Common Standard
     * Accounting Origins Project
     * 
     * @version 2.1
     * @date 2025-12-19
     * @description Teaches that arbitrage makes exchange rates line up;
     *              the common standard is a lens for seeing that structure.
     */

    const { useState, useEffect } = React;

    // ============================================================
    // COLOR PALETTE
    // ============================================================
    const colors = {
      primary: '#00356b',
      sand: '#f5f1e8',
      earth: '#8b7355',
      earthLight: '#d4c4a8',
      earthDark: '#5c4d3d',
      accent: '#c9a227',
      clay: '#c4a574',
      clayLight: '#e8dcc8',
      clayDark: '#a08050',
      success: '#22c55e',
      successBg: '#f0fdf4',
      warning: '#f59e0b',
      warningBg: '#fffbeb',
      error: '#dc2626',
      errorBg: '#fef2f2',
      profit: '#16a34a'
    };

    // ============================================================
    // SOUND FUNCTIONS
    // ============================================================
    const createAudioContext = () => {
      return new (window.AudioContext || window.webkitAudioContext)();
    };

    const playSuccessTone = () => {
      try {
        const ctx = createAudioContext();
        const notes = [523.25, 659.25, 783.99];
        const startTime = ctx.currentTime;
        
        notes.forEach((freq, i) => {
          const oscillator = ctx.createOscillator();
          const gainNode = ctx.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(ctx.destination);
          
          oscillator.frequency.value = freq;
          oscillator.type = 'sine';
          
          const noteStart = startTime + (i * 0.1);
          const noteEnd = noteStart + 0.15;
          
          gainNode.gain.setValueAtTime(0, noteStart);
          gainNode.gain.linearRampToValueAtTime(0.3, noteStart + 0.02);
          gainNode.gain.exponentialRampToValueAtTime(0.01, noteEnd);
          
          oscillator.start(noteStart);
          oscillator.stop(noteEnd + 0.1);
        });
        
        setTimeout(() => ctx.close(), 600);
      } catch (e) {
        console.log('Audio not available');
      }
    };

    const playSoftNope = () => {
      try {
        const ctx = createAudioContext();
        const notes = [400, 300];
        const startTime = ctx.currentTime;
        
        notes.forEach((freq, i) => {
          const oscillator = ctx.createOscillator();
          const gainNode = ctx.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(ctx.destination);
          
          oscillator.frequency.value = freq;
          oscillator.type = 'sine';
          
          const noteStart = startTime + (i * 0.12);
          const noteEnd = noteStart + 0.12;
          
          gainNode.gain.setValueAtTime(0, noteStart);
          gainNode.gain.linearRampToValueAtTime(0.2, noteStart + 0.02);
          gainNode.gain.exponentialRampToValueAtTime(0.01, noteEnd);
          
          oscillator.start(noteStart);
          oscillator.stop(noteEnd + 0.05);
        });
        
        setTimeout(() => ctx.close(), 400);
      } catch (e) {
        console.log('Audio not available');
      }
    };

    const playBuzzer = () => {
      try {
        const ctx = createAudioContext();
        const oscillator = ctx.createOscillator();
        const gainNode = ctx.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(ctx.destination);
        
        oscillator.frequency.value = 150;
        oscillator.type = 'sawtooth';
        
        const startTime = ctx.currentTime;
        gainNode.gain.setValueAtTime(0.25, startTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.3);
        
        oscillator.start(startTime);
        oscillator.stop(startTime + 0.35);
        
        setTimeout(() => ctx.close(), 400);
      } catch (e) {
        console.log('Audio not available');
      }
    };

    const playContinueClick = () => {
      try {
        const ctx = createAudioContext();
        const oscillator = ctx.createOscillator();
        const gainNode = ctx.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(ctx.destination);
        
        oscillator.frequency.value = 600;
        oscillator.type = 'sine';
        
        const startTime = ctx.currentTime;
        gainNode.gain.setValueAtTime(0, startTime);
        gainNode.gain.linearRampToValueAtTime(0.15, startTime + 0.01);
        gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.08);
        
        oscillator.start(startTime);
        oscillator.stop(startTime + 0.1);
        
        setTimeout(() => ctx.close(), 150);
      } catch (e) {
        console.log('Audio not available');
      }
    };

    // ============================================================
    // GLOSSARY TERMS
    // ============================================================
    const glossaryTerms = [
      {
        term: 'Exchange Ratio',
        definition: 'The rate at which two goods trade directly (e.g., "2 barley for 1 wool").'
      },
      {
        term: 'Common Standard',
        definition: 'A good used as a reference point to express what other goods can command. Makes comparison easier.'
      },
      {
        term: 'Commensurable',
        definition: 'Able to be compared because they\'re expressed in the same terms. "6 barley" and "8 barley" are commensurable; "3 wool" and "2 pots" are not.'
      },
      {
        term: 'Arbitrage',
        definition: 'Profiting from inconsistent rates by trading in a cycle. Not cheating — just using information.'
      },
      {
        term: 'Mispricing',
        definition: 'When exchange rates are inconsistent with each other, creating arbitrage opportunities.'
      }
    ];

    // ============================================================
    // ICONS (SVG components)
    // ============================================================
    const MapPinIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/>
        <circle cx="12" cy="10" r="3"/>
      </svg>
    );

    const BookIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/>
      </svg>
    );

    const RefreshIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
        <path d="M21 3v5h-5"/>
        <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
        <path d="M8 16H3v5"/>
      </svg>
    );

    const ChevronRightIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="m9 18 6-6-6-6"/>
      </svg>
    );

    const ChevronLeftIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="m15 18-6-6 6-6"/>
      </svg>
    );

    const ChevronDownIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="m6 9 6 6 6-6"/>
      </svg>
    );

    const ChevronUpIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="m18 15-6-6-6 6"/>
      </svg>
    );

    const InfoIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="12" cy="12" r="10"/>
        <path d="M12 16v-4"/>
        <path d="M12 8h.01"/>
      </svg>
    );

    const CheckCircleIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
        <path d="m9 11 3 3L22 4"/>
      </svg>
    );

    const TrophyIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/>
        <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/>
        <path d="M4 22h16"/>
        <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/>
        <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/>
        <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/>
      </svg>
    );

    const LightbulbIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/>
        <path d="M9 18h6"/>
        <path d="M10 22h4"/>
      </svg>
    );

    // Good icons
    const BarleyIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M12 2v20"/>
        <path d="M8 6c0-1.5 1.5-3 4-3s4 1.5 4 3c0 2-2 3-4 3s-4-1-4-3z"/>
        <path d="M8 12c0-1.5 1.5-3 4-3s4 1.5 4 3c0 2-2 3-4 3s-4-1-4-3z"/>
        <path d="M8 18c0-1.5 1.5-3 4-3s4 1.5 4 3"/>
      </svg>
    );

    const WoolIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="12" cy="12" r="8"/>
        <path d="M12 4c-2 2-2 4 0 6s2 4 0 6"/>
        <path d="M8 8c2 0 4 2 4 4s-2 4-4 4"/>
        <path d="M16 8c-2 0-4 2-4 4s2 4 4 4"/>
      </svg>
    );

    const PotteryIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M8 2h8"/>
        <path d="M9 2v2"/>
        <path d="M15 2v2"/>
        <path d="M7 4h10c1 4 1 8-1 12H8c-2-4-2-8-1-12z"/>
        <path d="M6 16h12"/>
        <path d="M7 16c-1 2-1 4 0 6h10c1-2 1-4 0-6"/>
      </svg>
    );

    const ArrowRightIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M5 12h14"/>
        <path d="m12 5 7 7-7 7"/>
      </svg>
    );

    // ============================================================
    // MAIN TUTORIAL COMPONENT
    // ============================================================
    const Tutorial14 = () => {
      // Phase management
      const phaseOrder = ['welcome', 'phase1', 'phase2', 'phase3', 'phase4', 'phase5', 'coda', 'complete'];
      const [phase, setPhase] = useState('welcome');
      
      // UI state
      const [showGlossary, setShowGlossary] = useState(false);
      const [showHistoricalNote, setShowHistoricalNote] = useState(false);
      const [devMode, setDevMode] = useState(false);
      const [headerClickCount, setHeaderClickCount] = useState(0);
      
      // Q1 state (Complexity Problem)
      const [q1Answer, setQ1Answer] = useState('');
      const [q1Attempts, setQ1Attempts] = useState(0);
      const [q1Submitted, setQ1Submitted] = useState(false);
      
      // Q2 state (Watch Kira)
      const [showKiraTrades, setShowKiraTrades] = useState(false);
      const [kiraTradeIndex, setKiraTradeIndex] = useState(-1);
      const [kiraTradesComplete, setKiraTradesComplete] = useState(false);
      const [q2Answer, setQ2Answer] = useState('');
      const [q2Attempts, setQ2Attempts] = useState(0);
      const [q2Submitted, setQ2Submitted] = useState(false);
      
      // Q3 state (Gap Calculator)
      const [giveValue, setGiveValue] = useState('');
      const [receiveValue, setReceiveValue] = useState('');
      const [dealAssessment, setDealAssessment] = useState('');
      const [q3Attempts, setQ3Attempts] = useState(0);
      const [q3Submitted, setQ3Submitted] = useState(false);
      
      // Q4 state (Why Rates Line Up)
      const [q4Answer, setQ4Answer] = useState('');
      const [q4Attempts, setQ4Attempts] = useState(0);
      const [q4Submitted, setQ4Submitted] = useState(false);
      
      // Q5 state (Is Barley Special?)
      const [q5Choice, setQ5Choice] = useState('');
      const [q5Explanation, setQ5Explanation] = useState('');
      const [q5Attempts, setQ5Attempts] = useState(0);
      const [q5Submitted, setQ5Submitted] = useState(false);

      // Progress calculation
      const currentPhaseIndex = phaseOrder.indexOf(phase);
      const progress = Math.round((currentPhaseIndex / (phaseOrder.length - 1)) * 100);

      // Header click handler for dev mode
      const handleHeaderClick = () => {
        const newCount = headerClickCount + 1;
        setHeaderClickCount(newCount);
        if (newCount >= 3) {
          setDevMode(!devMode);
          setHeaderClickCount(0);
        }
      };

      // Restart handler
      const handleRestart = () => {
        playContinueClick();
        setPhase('welcome');
        setQ1Answer('');
        setQ1Attempts(0);
        setQ1Submitted(false);
        setShowKiraTrades(false);
        setKiraTradeIndex(-1);
        setKiraTradesComplete(false);
        setQ2Answer('');
        setQ2Attempts(0);
        setQ2Submitted(false);
        setGiveValue('');
        setReceiveValue('');
        setDealAssessment('');
        setQ3Attempts(0);
        setQ3Submitted(false);
        setQ4Answer('');
        setQ4Attempts(0);
        setQ4Submitted(false);
        setQ5Choice('');
        setQ5Explanation('');
        setQ5Attempts(0);
        setQ5Submitted(false);
        setShowHistoricalNote(false);
        window.scrollTo(0, 0);
      };

      // Kira trade animation
      const startKiraAnimation = () => {
        playContinueClick();
        setShowKiraTrades(true);
        setKiraTradeIndex(0);
        
        setTimeout(() => setKiraTradeIndex(1), 1500);
        setTimeout(() => setKiraTradeIndex(2), 3000);
        setTimeout(() => {
          setKiraTradeIndex(3);
          setKiraTradesComplete(true);
        }, 4500);
      };

      // Q1 evaluation
      const evaluateQ1 = () => {
        const answer = q1Answer.toLowerCase().trim();
        const acceptKeywords = ['no', 'hard', 'can\'t', 'cannot', 'not sure', 'unclear', 'difficult', 'impossible', 'don\'t know'];
        const isAccepted = acceptKeywords.some(k => answer.includes(k)) || answer.length > 15;
        
        if (isAccepted) {
          playSuccessTone();
          setQ1Submitted(true);
        } else {
          const newAttempts = q1Attempts + 1;
          setQ1Attempts(newAttempts);
          if (newAttempts >= 3) {
            playBuzzer();
            setQ1Submitted(true);
          } else {
            playSoftNope();
          }
        }
      };

      // Q2 evaluation
      const evaluateQ2 = () => {
        const answer = q2Answer.toLowerCase().trim();
        const acceptKeywords = ['inconsistent', 'mispric', 'don\'t fit', 'don\'t match', 'gap', 'wrong', 'off', 'arbitrage', 'doesn\'t fit', 'not consistent'];
        const isAccepted = acceptKeywords.some(k => answer.includes(k)) || answer.length > 20;
        
        if (isAccepted) {
          playSuccessTone();
          setQ2Submitted(true);
        } else {
          const newAttempts = q2Attempts + 1;
          setQ2Attempts(newAttempts);
          if (newAttempts >= 3) {
            playBuzzer();
            setQ2Submitted(true);
          } else {
            playSoftNope();
          }
        }
      };

      // Q3 evaluation (Gap Calculator)
      const evaluateQ3 = () => {
        const give = parseInt(giveValue);
        const receive = parseInt(receiveValue);
        const isCorrect = give === 6 && receive === 8 && dealAssessment === 'good';
        
        if (isCorrect) {
          playSuccessTone();
          setQ3Submitted(true);
        } else {
          const newAttempts = q3Attempts + 1;
          setQ3Attempts(newAttempts);
          if (newAttempts >= 3) {
            playBuzzer();
            setQ3Submitted(true);
          } else {
            playSoftNope();
          }
        }
      };

      // Q4 evaluation
      const evaluateQ4 = () => {
        const answer = q4Answer.toLowerCase().trim();
        const acceptKeywords = ['arbitrage', 'traders', 'exploit', 'profit', 'adjust', 'close', 'eliminate', 'consistent', 'correct', 'opportunity', 'gap'];
        const isAccepted = acceptKeywords.some(k => answer.includes(k)) || answer.length > 30;
        
        if (isAccepted) {
          playSuccessTone();
          setQ4Submitted(true);
        } else {
          const newAttempts = q4Attempts + 1;
          setQ4Attempts(newAttempts);
          if (newAttempts >= 3) {
            playBuzzer();
            setQ4Submitted(true);
          } else {
            playSoftNope();
          }
        }
      };

      // Q5 evaluation
      const evaluateQ5 = () => {
        const explanation = q5Explanation.toLowerCase().trim();
        const hasDepends = explanation.includes('depend') || explanation.includes('different') || 
                          explanation.includes('wool') || explanation.includes('pot') ||
                          explanation.includes('trading for') || explanation.includes('relative');
        const isCorrect = q5Choice === 'no' && hasDepends && explanation.length > 10;
        
        if (isCorrect) {
          playSuccessTone();
          setQ5Submitted(true);
        } else {
          const newAttempts = q5Attempts + 1;
          setQ5Attempts(newAttempts);
          if (newAttempts >= 3) {
            playBuzzer();
            setQ5Submitted(true);
          } else {
            playSoftNope();
          }
        }
      };

      // Q1 hints
      const q1Hints = [
        "Try to compare... but compare to what?",
        "If you don't see anything obvious, that's the point."
      ];

      // Q2 hints
      const q2Hints = [
        "Each individual trade was at the market rate...",
        "But somehow 12 became 16. The rates must not fit together properly.",
        "Something about those three rates creates an opportunity..."
      ];

      // Q3 hints
      const q3Hints = [
        "From the first rate: 2 barley = 1 wool, so 1 wool is... how many barley?",
        "From the second rate: 4 barley = 1 pot, so 1 pot is... how many barley?",
        "Now apply those to 3 wool and 2 pots..."
      ];

      // Q4 hints
      const q4Hints = [
        "What happens when many traders see the same gap Kira saw?",
        "If buying wool is profitable, what happens to the demand for wool?",
        "Inconsistencies are opportunities. What happens to opportunities?"
      ];

      // Q5 hints
      const q5Hints = [
        "What does barley get you in wool? What does it get you in pottery?",
        "Are those the same number?"
      ];

      // ============================================================
      // REUSABLE COMPONENTS
      // ============================================================

      // Header with progress bar
      const Header = () => (
        <div 
          className="rounded-lg p-4 mb-4"
          style={{ backgroundColor: colors.primary }}
        >
          <div className="flex justify-between items-start">
            <div onClick={handleHeaderClick} style={{ cursor: 'pointer' }}>
              <div className="flex items-center gap-2">
                <span className="text-white"><MapPinIcon /></span>
                <h1 className="text-lg font-bold text-white">Tutorial 1.4: The Common Standard</h1>
              </div>
              <p className="text-sm mt-1" style={{ color: colors.earthLight }}>
                The Crossing, ~3500 BCE • ~10 min
              </p>
            </div>
            <div className="flex items-center gap-2">
              <button
                onClick={() => setShowGlossary(true)}
                className="p-2 rounded-lg hover:bg-white/10 transition-colors"
                title="Glossary"
              >
                <span className="text-white"><BookIcon /></span>
              </button>
              <button
                onClick={handleRestart}
                className="p-2 rounded-lg hover:bg-white/10 transition-colors"
                title="Restart tutorial"
              >
                <span className="text-white"><RefreshIcon /></span>
              </button>
            </div>
          </div>
          
          {/* Progress bar */}
          <div className="mt-4">
            <div className="flex justify-between text-xs text-white/70 mb-1">
              <span>Progress</span>
              <span>{progress}%</span>
            </div>
            <div className="h-2 rounded-full" style={{ backgroundColor: 'rgba(255,255,255,0.2)' }}>
              <div 
                className="h-full rounded-full transition-all duration-500"
                style={{ width: `${progress}%`, backgroundColor: colors.accent }}
              />
            </div>
          </div>
          
          {/* Dev mode controls */}
          {devMode && (
            <div className="mt-3 pt-3 border-t border-white/20">
              <p className="text-xs text-white/70 mb-2">Dev Mode: Skip to phase</p>
              <div className="flex flex-wrap gap-1">
                {phaseOrder.map(p => (
                  <button
                    key={p}
                    onClick={() => { setPhase(p); window.scrollTo(0, 0); }}
                    className={`px-2 py-1 rounded text-xs transition-colors ${
                      phase === p ? 'bg-white text-blue-900' : 'bg-white/20 text-white hover:bg-white/30'
                    }`}
                  >
                    {p}
                  </button>
                ))}
              </div>
            </div>
          )}
        </div>
      );

      // Glossary Modal
      const GlossaryModal = () => (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-xl max-w-md w-full max-h-[80vh] overflow-y-auto shadow-xl">
            <div className="p-4 border-b sticky top-0 bg-white flex justify-between items-center">
              <h3 className="font-bold" style={{ color: colors.primary }}>Glossary</h3>
              <button 
                onClick={() => setShowGlossary(false)} 
                className="text-gray-500 hover:text-gray-700 text-xl font-bold w-8 h-8 flex items-center justify-center rounded hover:bg-gray-100"
              >
                ×
              </button>
            </div>
            <div className="p-4 space-y-4">
              {glossaryTerms.map((item, i) => (
                <div key={i}>
                  <p className="font-semibold" style={{ color: colors.primary }}>{item.term}</p>
                  <p className="text-gray-600 text-sm mt-1">{item.definition}</p>
                </div>
              ))}
            </div>
          </div>
        </div>
      );

      // Narrative Block
      const NarrativeBlock = ({ children }) => (
        <div 
          className="p-4 rounded-lg border-l-4 mb-4"
          style={{ backgroundColor: colors.sand, borderColor: colors.accent }}
        >
          <div className="narrative-text text-gray-700">{children}</div>
        </div>
      );

      // Continue Button
      const ContinueButton = ({ onClick, children = "Continue" }) => (
        <button
          onClick={() => { playContinueClick(); onClick(); window.scrollTo(0, 0); }}
          className="w-full py-3 rounded-lg font-bold text-white flex items-center justify-center gap-2 btn-primary transition-all"
          style={{ backgroundColor: colors.primary }}
        >
          {children} <ChevronRightIcon />
        </button>
      );

      // Previous Page Button
      const PreviousPageButton = ({ onClick }) => (
        <button
          onClick={() => { playContinueClick(); onClick(); window.scrollTo(0, 0); }}
          className="mb-4 py-3 px-5 rounded-lg font-semibold flex items-center gap-2 transition-all shadow-sm"
          style={{
            color: colors.primary,
            backgroundColor: 'white',
            border: `2px solid ${colors.primary}`,
            fontSize: '15px'
          }}
        >
          <ChevronLeftIcon /> Previous Page
        </button>
      );

      // Get previous phase
      const getPreviousPhase = () => {
        const idx = phaseOrder.indexOf(phase);
        return idx > 0 ? phaseOrder[idx - 1] : null;
      };

      // Insight Panel
      const InsightPanel = ({ title, children }) => (
        <div 
          className="p-4 rounded-lg border-2 mb-4"
          style={{ backgroundColor: colors.successBg, borderColor: colors.success }}
        >
          <div className="flex items-start gap-3">
            <span className="flex-shrink-0 mt-0.5" style={{ color: colors.success }}>
              <CheckCircleIcon />
            </span>
            <div>
              {title && <p className="font-bold mb-2" style={{ color: colors.success }}>{title}</p>}
              <div style={{ color: '#166534' }}>{children}</div>
            </div>
          </div>
        </div>
      );

      // Key Insight Box
      const KeyInsightBox = ({ children }) => (
        <div 
          className="p-4 rounded-lg border-2 mb-4"
          style={{ backgroundColor: '#fef9e7', borderColor: colors.accent }}
        >
          <div className="flex items-start gap-3">
            <span className="flex-shrink-0 mt-0.5" style={{ color: colors.accent }}>
              <LightbulbIcon />
            </span>
            <div style={{ color: colors.earthDark }}>{children}</div>
          </div>
        </div>
      );

      // Hint Display
      const HintDisplay = ({ attempts, hints }) => {
        if (attempts === 0 || attempts > hints.length) return null;
        return (
          <div className="mt-3 p-3 rounded-lg" style={{ backgroundColor: colors.warningBg }}>
            <p className="text-sm" style={{ color: '#92400e' }}>
              <strong>Hint {attempts}/{hints.length}:</strong> {hints[attempts - 1]}
            </p>
          </div>
        );
      };

      // Third Strike Reveal
      const ThirdStrikeReveal = ({ show, answer }) => {
        if (!show) return null;
        return (
          <div className="mt-3 p-3 rounded-lg border" style={{ backgroundColor: colors.warningBg, borderColor: colors.warning }}>
            <p className="text-sm font-medium" style={{ color: '#92400e' }}>
              Here's what we were looking for:
            </p>
            <p className="text-sm mt-1" style={{ color: '#92400e' }}>
              {answer}
            </p>
          </div>
        );
      };

      // Rate Card
      const RateCard = ({ good1, good2, ratio, icon1, icon2 }) => (
        <div 
          className="p-3 rounded-lg border bg-white"
          style={{ borderColor: colors.earthLight }}
        >
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-2">
              <span style={{ color: colors.earth }}>{icon1}</span>
              <span className="text-gray-400">↔</span>
              <span style={{ color: colors.earth }}>{icon2}</span>
            </div>
            <span className="font-mono text-sm font-semibold" style={{ color: colors.earthDark }}>
              {ratio}
            </span>
          </div>
          <p className="text-xs mt-2 text-gray-500">{good1} ↔ {good2}</p>
        </div>
      );

      // ============================================================
      // PHASE RENDERS
      // ============================================================

      // WELCOME
      const renderWelcome = () => (
        <div className="min-h-screen fade-in" style={{ backgroundColor: colors.sand }}>
          <div className="p-4 max-w-2xl mx-auto pb-20">
            <Header />
            
            <NarrativeBlock>
              <p className="mb-3">
                The wool trade is done. You linger at the market, watching.
              </p>
              <p className="mb-3">
                Three goods dominate the trading: barley, wool, and pottery. Calls ring out — "Two barley for one wool!" "Four barley for one pot!" — but also "Three wool for two pots!"
              </p>
              <p>
                Then you notice something. An old trader keeps trading in cycles. Barley to wool to pottery and back to barley. And somehow, she always ends up with more than she started.
              </p>
            </NarrativeBlock>
            
            {/* What You'll Discover */}
            <div 
              className="p-4 rounded-lg border-2 mb-4"
              style={{ backgroundColor: 'white', borderColor: colors.primary }}
            >
              <h3 className="font-bold mb-3" style={{ color: colors.primary }}>What You'll Discover</h3>
              <ol className="space-y-2 text-sm" style={{ color: colors.earthDark }}>
                <li className="flex gap-2">
                  <span className="font-bold" style={{ color: colors.primary }}>1.</span>
                  Exchange ratios are hard to compare directly
                </li>
                <li className="flex gap-2">
                  <span className="font-bold" style={{ color: colors.primary }}>2.</span>
                  A common standard makes comparison immediate
                </li>
                <li className="flex gap-2">
                  <span className="font-bold" style={{ color: colors.primary }}>3.</span>
                  How traders calling out rates in public leads to consistency across all traded goods
                </li>
                <li className="flex gap-2">
                  <span className="font-bold" style={{ color: colors.primary }}>4.</span>
                  The standard is a lens for seeing, not the source of the structure
                </li>
              </ol>
            </div>
            
            {/* Historical Liberties Note */}
            <div className="mb-4">
              <button
                onClick={() => setShowHistoricalNote(!showHistoricalNote)}
                className="w-full flex items-center justify-between p-3 rounded-lg text-sm"
                style={{ backgroundColor: colors.clayLight, color: colors.earthDark }}
              >
                <div className="flex items-center gap-2">
                  <InfoIcon />
                  <span className="font-medium">A Note on Historical Liberties</span>
                </div>
                {showHistoricalNote ? <ChevronUpIcon /> : <ChevronDownIcon />}
              </button>
              
              {showHistoricalNote && (
                <div 
                  className="mt-2 p-4 rounded-lg text-sm border"
                  style={{ backgroundColor: 'white', borderColor: colors.earthLight, color: colors.earthDark }}
                >
                  <p className="mb-3">
                    This tutorial is set in a fictional pre-urban river valley, roughly 3500 BCE. The marketplace, the character of Kira, and the specific trade goods are imagined to illustrate economic concepts.
                  </p>
                  <p className="mb-3">
                    The tutorial takes liberties: real prehistoric exchange would have been more varied and less systematic than depicted. The clean "discovery" of arbitrage and common standards would have been gradual and uneven.
                  </p>
                  <p className="italic">
                    This is historical fiction in service of teaching accounting concepts — not a claim about how ancient economies actually worked.
                  </p>
                </div>
              )}
            </div>
            
            <ContinueButton onClick={() => setPhase('phase1')}>
              Begin Tutorial
            </ContinueButton>
          </div>
        </div>
      );

      // PHASE 1: The Complexity Problem
      const renderPhase1 = () => (
        <div className="min-h-screen fade-in" style={{ backgroundColor: colors.sand }}>
          <div className="p-4 max-w-2xl mx-auto pb-20">
            <Header />

            <PreviousPageButton onClick={() => setPhase('welcome')} />

            <NarrativeBlock>
              <p className="mb-3">
                You watch the market. Three goods. Three exchange rates:
              </p>
              <ul className="space-y-1 mb-3 not-italic">
                <li>• Barley ↔ Wool: <strong>2 barley for 1 wool</strong></li>
                <li>• Barley ↔ Pottery: <strong>4 barley for 1 pot</strong></li>
                <li>• Wool ↔ Pottery: <strong>3 wool for 2 pots</strong></li>
              </ul>
              <p>
                Each rate makes sense on its own. But do they fit together?
              </p>
            </NarrativeBlock>
            
            {/* Rate Cards */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
              <RateCard 
                good1="Barley" 
                good2="Wool" 
                ratio="2:1"
                icon1={<BarleyIcon />}
                icon2={<WoolIcon />}
              />
              <RateCard 
                good1="Barley" 
                good2="Pottery" 
                ratio="4:1"
                icon1={<BarleyIcon />}
                icon2={<PotteryIcon />}
              />
              <RateCard 
                good1="Wool" 
                good2="Pottery" 
                ratio="3:2"
                icon1={<WoolIcon />}
                icon2={<PotteryIcon />}
              />
            </div>
            
            {/* Question */}
            <div className="bg-white rounded-lg p-4 mb-4 shadow-sm">
              <p className="text-sm mb-3" style={{ color: colors.earthDark }}>
                <strong>Question:</strong> Looking at these three rates, can you tell if any trade is a particularly good or bad deal?
              </p>
              
              {!q1Submitted && (
                <>
                  <textarea
                    value={q1Answer}
                    onChange={(e) => setQ1Answer(e.target.value)}
                    placeholder="Your answer..."
                    rows={2}
                    className="w-full p-3 border rounded-lg text-sm resize-none mb-3"
                    style={{ borderColor: colors.earthLight }}
                  />
                  <button
                    onClick={evaluateQ1}
                    disabled={q1Answer.trim().length < 2}
                    className="w-full py-3 rounded-lg font-bold text-white disabled:opacity-50 transition-all"
                    style={{ backgroundColor: colors.primary }}
                  >
                    Check
                  </button>
                  
                  {!q1Submitted && <HintDisplay attempts={q1Attempts} hints={q1Hints} />}
                </>
              )}
              
              {q1Submitted && q1Attempts >= 3 && (
                <ThirdStrikeReveal 
                  show={true} 
                  answer="It's hard to tell — the rates use different units and don't obviously compare." 
                />
              )}
            </div>
            
            {/* Explanation after submission */}
            {q1Submitted && (
              <>
                <InsightPanel>
                  <p className="mb-2">
                    If you couldn't spot anything wrong, you're in good company. Most people can't — not because they're missing something, but because there's nothing obvious to see.
                  </p>
                  <p className="mb-2">
                    Each ratio compares two goods directly. But there's no common basis for comparison. How do you compare "2 barley : 1 wool" to "3 wool : 2 pots"? The units are different. The numbers just sit there.
                  </p>
                  <p>
                    Maybe someone who trades here every day can see patterns you can't. Let's watch and find out.
                  </p>
                </InsightPanel>
                
                <ContinueButton onClick={() => setPhase('phase2')}>
                  Continue
                </ContinueButton>
              </>
            )}
          </div>
        </div>
      );

      // PHASE 2: Watch Kira
      const renderPhase2 = () => (
        <div className="min-h-screen fade-in" style={{ backgroundColor: colors.sand }}>
          <div className="p-4 max-w-2xl mx-auto pb-20">
            <Header />

            <PreviousPageButton onClick={() => setPhase('phase1')} />

            <NarrativeBlock>
              <p className="mb-3">
                You watch the old trader more closely. Her name, you learn, is Kira. She's from somewhere downstream — been trading longer than anyone can remember.
              </p>
              <p>
                She doesn't haggle. She doesn't rush. She just moves through the market, making trades.
              </p>
            </NarrativeBlock>
            
            {/* Watch Kira's Trades */}
            {!showKiraTrades && (
              <button
                onClick={startKiraAnimation}
                className="w-full py-4 rounded-lg font-bold text-white mb-4 flex items-center justify-center gap-2 btn-primary transition-all"
                style={{ backgroundColor: colors.primary }}
              >
                Watch Kira's Trades <ArrowRightIcon />
              </button>
            )}
            
            {showKiraTrades && (
              <div 
                className="rounded-lg p-4 mb-4 border-2"
                style={{ backgroundColor: 'white', borderColor: colors.clayDark }}
              >
                <h4 className="font-bold mb-3" style={{ color: colors.primary }}>Kira's Trading Cycle</h4>
                
                <div className="space-y-3">
                  {/* Trade 1 */}
                  {kiraTradeIndex >= 0 && (
                    <div 
                      className="p-3 rounded-lg trade-step"
                      style={{ backgroundColor: colors.clayLight, animationDelay: '0s' }}
                    >
                      <div className="flex items-center gap-2">
                        <span style={{ color: colors.earth }}><BarleyIcon /></span>
                        <span className="font-mono">12 barley</span>
                        <span className="mx-2">→</span>
                        <span style={{ color: colors.earth }}><WoolIcon /></span>
                        <span className="font-mono">6 wool</span>
                      </div>
                      <p className="text-xs text-gray-500 mt-1">at 2:1 rate</p>
                    </div>
                  )}
                  
                  {/* Trade 2 */}
                  {kiraTradeIndex >= 1 && (
                    <div 
                      className="p-3 rounded-lg trade-step"
                      style={{ backgroundColor: colors.clayLight, animationDelay: '0s' }}
                    >
                      <div className="flex items-center gap-2">
                        <span style={{ color: colors.earth }}><WoolIcon /></span>
                        <span className="font-mono">6 wool</span>
                        <span className="mx-2">→</span>
                        <span style={{ color: colors.earth }}><PotteryIcon /></span>
                        <span className="font-mono">4 pots</span>
                      </div>
                      <p className="text-xs text-gray-500 mt-1">at 3:2 rate</p>
                    </div>
                  )}
                  
                  {/* Trade 3 */}
                  {kiraTradeIndex >= 2 && (
                    <div 
                      className="p-3 rounded-lg trade-step"
                      style={{ backgroundColor: colors.clayLight, animationDelay: '0s' }}
                    >
                      <div className="flex items-center gap-2">
                        <span style={{ color: colors.earth }}><PotteryIcon /></span>
                        <span className="font-mono">4 pots</span>
                        <span className="mx-2">→</span>
                        <span style={{ color: colors.earth }}><BarleyIcon /></span>
                        <span className="font-mono">16 barley</span>
                      </div>
                      <p className="text-xs text-gray-500 mt-1">at 4:1 rate</p>
                    </div>
                  )}
                  
                  {/* Result */}
                  {kiraTradeIndex >= 3 && (
                    <div 
                      className="p-4 rounded-lg border-2 trade-step"
                      style={{ backgroundColor: colors.successBg, borderColor: colors.success, animationDelay: '0s' }}
                    >
                      <div className="flex items-center justify-between">
                        <div>
                          <p className="text-sm text-gray-600">Started with:</p>
                          <p className="font-bold text-lg">12 barley</p>
                        </div>
                        <div className="text-2xl">→</div>
                        <div>
                          <p className="text-sm text-gray-600">Ended with:</p>
                          <p className="font-bold text-lg">16 barley</p>
                        </div>
                      </div>
                      <div 
                        className="mt-3 pt-3 border-t text-center"
                        style={{ borderColor: colors.success }}
                      >
                        <span className="font-bold text-lg" style={{ color: colors.profit }}>
                          Profit: +4 barley
                        </span>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            )}
            
            {/* Question - only show after animation complete */}
            {kiraTradesComplete && (
              <div className="bg-white rounded-lg p-4 mb-4 shadow-sm">
                <p className="text-sm mb-3" style={{ color: colors.earthDark }}>
                  <strong>Question:</strong> She started with 12 barley and ended with 16. Each trade was at the shouted rate. How is this possible?
                </p>
                
                {!q2Submitted && (
                  <>
                    <textarea
                      value={q2Answer}
                      onChange={(e) => setQ2Answer(e.target.value)}
                      placeholder="Your answer..."
                      rows={3}
                      className="w-full p-3 border rounded-lg text-sm resize-none mb-3"
                      style={{ borderColor: colors.earthLight }}
                    />
                    <button
                      onClick={evaluateQ2}
                      disabled={q2Answer.trim().length < 5}
                      className="w-full py-3 rounded-lg font-bold text-white disabled:opacity-50 transition-all"
                      style={{ backgroundColor: colors.primary }}
                    >
                      Check
                    </button>
                    
                    <HintDisplay attempts={q2Attempts} hints={q2Hints} />
                  </>
                )}
                
                {q2Submitted && q2Attempts >= 3 && (
                  <ThirdStrikeReveal 
                    show={true} 
                    answer="The rates are inconsistent with each other. When you trade in a cycle, the inconsistency creates a gap — and that gap is profit." 
                  />
                )}
              </div>
            )}
            
            {/* Explanation after submission */}
            {q2Submitted && (
              <>
                <InsightPanel>
                  <p className="mb-2">
                    You see the result clearly: 12 barley became 16. But how?
                  </p>
                  <p className="mb-2">
                    Each individual trade was at the market rate everyone was calling out. Nothing was hidden. Nothing was unfair. Yet somehow, trading in a cycle created profit from nothing.
                  </p>
                  <p className="mb-2">
                    Something about those three rates doesn't fit together. But what? You stare at them — 2:1, 4:1, 3:2 — and the numbers just sit there, refusing to reveal their secret.
                  </p>
                  <p className="italic">
                    Kira notices you watching. She gives a slight nod.
                  </p>
                </InsightPanel>
                
                <ContinueButton onClick={() => setPhase('phase3')}>
                  Continue
                </ContinueButton>
              </>
            )}
          </div>
        </div>
      );

      // PHASE 3: The Common Standard (Gap Calculator)
      const renderPhase3 = () => (
        <div className="min-h-screen fade-in" style={{ backgroundColor: colors.sand }}>
          <div className="p-4 max-w-2xl mx-auto pb-20">
            <Header />

            <PreviousPageButton onClick={() => setPhase('phase2')} />

            <NarrativeBlock>
              <p className="mb-3">
                "You're curious," Kira says. It's not a question.
              </p>
              <p className="mb-3">
                You nod. "How did you do that?"
              </p>
              <p className="mb-3">
                She picks up a stick, scratches in the dirt.
              </p>
              <p>
                "When you look at the rates, you see three different comparisons. Barley to wool. Barley to pottery. Wool to pottery. Hard to hold them all in your head."
              </p>
            </NarrativeBlock>
            
            {/* Kira's Method */}
            <div 
              className="rounded-lg p-4 mb-4 border-2"
              style={{ backgroundColor: 'white', borderColor: colors.accent }}
            >
              <h4 className="font-bold mb-3" style={{ color: colors.primary }}>
                "But what if you state everything in barley?"
              </h4>
              
              <div className="space-y-2 mb-4">
                <div className="p-3 rounded-lg" style={{ backgroundColor: colors.clayLight }}>
                  <p className="text-sm">From rate 1: 2 barley = 1 wool</p>
                  <p className="font-bold" style={{ color: colors.primary }}>→ 1 wool = 2 barley</p>
                </div>
                <div className="p-3 rounded-lg" style={{ backgroundColor: colors.clayLight }}>
                  <p className="text-sm">From rate 2: 4 barley = 1 pot</p>
                  <p className="font-bold" style={{ color: colors.primary }}>→ 1 pot = 4 barley</p>
                </div>
              </div>
              
              <p className="text-sm italic" style={{ color: colors.earthDark }}>
                "Now check the wool↔pottery trade (3 wool : 2 pots):"
              </p>
            </div>
            
            {/* Gap Calculator */}
            <div className="bg-white rounded-lg p-4 mb-4 shadow-sm">
              <h4 className="font-bold mb-4" style={{ color: colors.primary }}>Gap Calculator</h4>
              
              <div className="space-y-4">
                {/* Give input */}
                <div>
                  <label className="block text-sm font-medium mb-2" style={{ color: colors.earthDark }}>
                    You give 3 wool = ___ barley
                  </label>
                  <div className="flex items-center gap-2">
                    <input
                      type="text"
                      inputMode="numeric"
                      pattern="[0-9]*"
                      value={giveValue}
                      onChange={(e) => setGiveValue(e.target.value.replace(/\D/g, ''))}
                      disabled={q3Submitted}
                      placeholder="?"
                      className="w-24 p-3 border rounded-lg text-center font-mono text-lg"
                      style={{ borderColor: colors.earthLight }}
                    />
                    <span className="text-sm" style={{ color: colors.earth }}>barley</span>
                  </div>
                </div>
                
                {/* Receive input */}
                <div>
                  <label className="block text-sm font-medium mb-2" style={{ color: colors.earthDark }}>
                    You receive 2 pots = ___ barley
                  </label>
                  <div className="flex items-center gap-2">
                    <input
                      type="text"
                      inputMode="numeric"
                      pattern="[0-9]*"
                      value={receiveValue}
                      onChange={(e) => setReceiveValue(e.target.value.replace(/\D/g, ''))}
                      disabled={q3Submitted}
                      placeholder="?"
                      className="w-24 p-3 border rounded-lg text-center font-mono text-lg"
                      style={{ borderColor: colors.earthLight }}
                    />
                    <span className="text-sm" style={{ color: colors.earth }}>barley</span>
                  </div>
                </div>
                
                {/* Gap display */}
                {giveValue && receiveValue && (
                  <div 
                    className="p-3 rounded-lg text-center"
                    style={{ backgroundColor: colors.clayLight }}
                  >
                    <p className="text-sm" style={{ color: colors.earthDark }}>
                      Gap: {receiveValue} − {giveValue} = <strong>{parseInt(receiveValue || 0) - parseInt(giveValue || 0)} barley</strong>
                    </p>
                  </div>
                )}
                
                {/* Assessment */}
                <div>
                  <label className="block text-sm font-medium mb-2" style={{ color: colors.earthDark }}>
                    Is this a good deal, bad deal, or fair?
                  </label>
                  <div className="grid grid-cols-3 gap-2">
                    {['good', 'bad', 'fair'].map(option => (
                      <button
                        key={option}
                        onClick={() => !q3Submitted && setDealAssessment(option)}
                        disabled={q3Submitted}
                        className={`py-3 px-4 rounded-lg border-2 font-semibold capitalize transition-all ${
                          dealAssessment === option 
                            ? 'border-blue-500 bg-blue-50' 
                            : 'border-gray-200 hover:border-gray-300'
                        }`}
                        style={{ 
                          borderColor: dealAssessment === option ? colors.primary : undefined,
                          backgroundColor: dealAssessment === option ? '#eff6ff' : undefined
                        }}
                      >
                        {option}
                      </button>
                    ))}
                  </div>
                </div>
                
                {/* Submit */}
                {!q3Submitted && (
                  <>
                    <button
                      onClick={evaluateQ3}
                      disabled={!giveValue || !receiveValue || !dealAssessment}
                      className="w-full py-3 rounded-lg font-bold text-white disabled:opacity-50 transition-all"
                      style={{ backgroundColor: colors.primary }}
                    >
                      Check
                    </button>
                    
                    <HintDisplay attempts={q3Attempts} hints={q3Hints} />
                  </>
                )}
                
                {q3Submitted && q3Attempts >= 3 && (
                  <ThirdStrikeReveal 
                    show={true} 
                    answer="3 wool = 6 barley, 2 pots = 8 barley. You give 6, receive 8. That's a good deal!" 
                  />
                )}
              </div>
            </div>
            
            {/* Explanation after submission */}
            {q3Submitted && (
              <>
                <InsightPanel>
                  <p className="mb-2">
                    There it is. You give 6 barley's worth of wool and receive 8 barley's worth of pottery. That's a gain of 2 barley every time you make this trade.
                  </p>
                  <p className="mb-2">
                    The gap was invisible when you looked at "3 wool : 2 pots" — those are just numbers in different units. But when you express both sides in barley, the inconsistency jumps out.
                  </p>
                  <p className="italic">
                    "The common standard doesn't change what things can get you," Kira says. "It just lets you see what was always there."
                  </p>
                </InsightPanel>
                
                <ContinueButton onClick={() => setPhase('phase4')}>
                  Continue
                </ContinueButton>
              </>
            )}
          </div>
        </div>
      );

      // PHASE 4: Why Rates Line Up
      const renderPhase4 = () => (
        <div className="min-h-screen fade-in" style={{ backgroundColor: colors.sand }}>
          <div className="p-4 max-w-2xl mx-auto pb-20">
            <Header />

            <PreviousPageButton onClick={() => setPhase('phase3')} />

            <NarrativeBlock>
              <p className="mb-3">
                You sit with this for a moment.
              </p>
              <p>
                But here's what puzzles you: if these gaps exist, why doesn't everyone see them? Why don't they get exploited until they disappear?
              </p>
            </NarrativeBlock>
            
            {/* Kira's response */}
            <div 
              className="rounded-lg p-4 mb-4 border-l-4"
              style={{ backgroundColor: colors.clayLight, borderColor: colors.accent }}
            >
              <p className="font-bold mb-2" style={{ color: colors.primary }}>Kira:</p>
              <p className="italic mb-2" style={{ color: colors.earthDark }}>
                "They do. I'm not the only one watching. Other traders see the same gap. They start making the same trades."
              </p>
              <p className="italic mb-2" style={{ color: colors.earthDark }}>
                "When everyone buys wool at the wool↔pottery rate, wool gets scarcer there. The potter has to offer more pots for the same wool. When everyone sells pottery for barley, pottery piles up. The barley traders offer less."
              </p>
              <p className="italic" style={{ color: colors.earthDark }}>
                "The gap closes. Not because someone declared it should — but because traders chasing profit <em>made</em> it close."
              </p>
            </div>
            
            {/* Question */}
            <div className="bg-white rounded-lg p-4 mb-4 shadow-sm">
              <p className="text-sm mb-3" style={{ color: colors.earthDark }}>
                <strong>Question:</strong> Why do exchange rates across a market tend to line up with each other?
              </p>
              
              {!q4Submitted && (
                <>
                  <textarea
                    value={q4Answer}
                    onChange={(e) => setQ4Answer(e.target.value)}
                    placeholder="Your answer..."
                    rows={3}
                    className="w-full p-3 border rounded-lg text-sm resize-none mb-3"
                    style={{ borderColor: colors.earthLight }}
                  />
                  <button
                    onClick={evaluateQ4}
                    disabled={q4Answer.trim().length < 10}
                    className="w-full py-3 rounded-lg font-bold text-white disabled:opacity-50 transition-all"
                    style={{ backgroundColor: colors.primary }}
                  >
                    Check
                  </button>
                  
                  <HintDisplay attempts={q4Attempts} hints={q4Hints} />
                </>
              )}
              
              {q4Submitted && q4Attempts >= 3 && (
                <ThirdStrikeReveal 
                  show={true} 
                  answer="Arbitrage — traders exploit inconsistencies for profit, and their trading closes the gaps." 
                />
              )}
            </div>
            
            {/* Explanation after submission */}
            {q4Submitted && (
              <>
                <InsightPanel>
                  <p className="mb-2">
                    Exchange rates line up because inconsistencies are opportunities — and opportunities get exploited until they disappear.
                  </p>
                  <p className="mb-2">
                    This process has a name: <strong>arbitrage</strong>. It's not just that clever traders profit. It's that their profit-seeking <em>creates</em> consistency. Buy the underpriced good, its price rises. Sell the overpriced good, its price falls. The gap closes.
                  </p>
                  <p className="font-semibold">
                    Arbitrage knits all the exchange rates together into a consistent structure. The common standard lets you see that structure — but arbitrage is what creates and maintains it.
                  </p>
                </InsightPanel>
                
                <KeyInsightBox>
                  <p>
                    The rates <em>have</em> to line up because if they don't, someone will exploit the gap until they do. That's why we can talk about "the" exchange relationship between any two goods — because if multiple inconsistent rates existed, they'd collapse into one.
                  </p>
                </KeyInsightBox>
                
                <ContinueButton onClick={() => setPhase('phase5')}>
                  Continue
                </ContinueButton>
              </>
            )}
          </div>
        </div>
      );

      // PHASE 5: Is Barley Special?
      const renderPhase5 = () => (
        <div className="min-h-screen fade-in" style={{ backgroundColor: colors.sand }}>
          <div className="p-4 max-w-2xl mx-auto pb-20">
            <Header />

            <PreviousPageButton onClick={() => setPhase('phase4')} />

            <NarrativeBlock>
              <p className="mb-3">
                "Why barley?" you ask.
              </p>
              <p className="mb-3">
                Kira shrugs. "It could be wool. Watch—"
              </p>
              <p>
                She scratches in the dirt again:
              </p>
            </NarrativeBlock>
            
            {/* Two-Way Rates Display */}
            <div className="grid md:grid-cols-2 gap-4 mb-4">
              <div className="p-4 rounded-lg" style={{ backgroundColor: 'white', border: `2px solid ${colors.earthLight}` }}>
                <p className="font-bold text-sm mb-3" style={{ color: colors.primary }}>In barley:</p>
                <ul className="space-y-1 text-sm" style={{ color: colors.earthDark }}>
                  <li>• 2 barley for 1 wool</li>
                  <li>• 4 barley for 1 pot</li>
                </ul>
              </div>
              <div className="p-4 rounded-lg" style={{ backgroundColor: 'white', border: `2px solid ${colors.earthLight}` }}>
                <p className="font-bold text-sm mb-3" style={{ color: colors.primary }}>In wool:</p>
                <ul className="space-y-1 text-sm" style={{ color: colors.earthDark }}>
                  <li>• 1 wool for 2 barley</li>
                  <li>• 2 wool for 1 pot</li>
                </ul>
              </div>
            </div>
            
            <div 
              className="rounded-lg p-3 mb-4 italic text-sm"
              style={{ backgroundColor: colors.clayLight, color: colors.earthDark }}
            >
              "Same trades. I just said them starting from wool instead of barley."
            </div>
            
            {/* Question */}
            <div className="bg-white rounded-lg p-4 mb-4 shadow-sm">
              <p className="text-sm mb-4" style={{ color: colors.earthDark }}>
                <strong>Question:</strong> Does barley have "a worth" — a single number that tells you what it can get you?
              </p>
              
              {/* Yes/No buttons */}
              <div className="grid grid-cols-2 gap-3 mb-4">
                <button
                  onClick={() => !q5Submitted && setQ5Choice('yes')}
                  disabled={q5Submitted}
                  className={`p-4 rounded-lg border-2 text-center font-bold transition-all ${
                    q5Choice === 'yes' ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'
                  }`}
                  style={{ 
                    borderColor: q5Submitted && 'no' === 'yes' ? colors.success : 
                                q5Choice === 'yes' ? colors.primary : undefined,
                    backgroundColor: q5Submitted && 'no' === 'yes' ? colors.successBg :
                                    q5Choice === 'yes' ? '#eff6ff' : undefined
                  }}
                >
                  Yes
                </button>
                <button
                  onClick={() => !q5Submitted && setQ5Choice('no')}
                  disabled={q5Submitted}
                  className={`p-4 rounded-lg border-2 text-center font-bold transition-all ${
                    q5Choice === 'no' ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'
                  }`}
                  style={{ 
                    borderColor: q5Submitted && 'no' === 'no' ? colors.success : 
                                q5Choice === 'no' ? colors.primary : undefined,
                    backgroundColor: q5Submitted && 'no' === 'no' ? colors.successBg :
                                    q5Choice === 'no' ? '#eff6ff' : undefined
                  }}
                >
                  No
                </button>
              </div>
              
              {/* Explanation text area */}
              {q5Choice && !q5Submitted && (
                <div className="mb-3">
                  <label className="block text-sm font-medium mb-2" style={{ color: colors.earthDark }}>
                    Explain briefly:
                  </label>
                  <textarea
                    value={q5Explanation}
                    onChange={(e) => setQ5Explanation(e.target.value)}
                    placeholder="Why do you think that?"
                    rows={2}
                    className="w-full p-3 border rounded-lg text-sm resize-none"
                    style={{ borderColor: colors.earthLight }}
                  />
                </div>
              )}
              
              {!q5Submitted && q5Choice && (
                <>
                  <button
                    onClick={evaluateQ5}
                    disabled={!q5Choice || q5Explanation.trim().length < 5}
                    className="w-full py-3 rounded-lg font-bold text-white disabled:opacity-50 transition-all"
                    style={{ backgroundColor: colors.primary }}
                  >
                    Check
                  </button>
                  
                  <HintDisplay attempts={q5Attempts} hints={q5Hints} />
                </>
              )}
              
              {q5Submitted && q5Attempts >= 3 && (
                <ThirdStrikeReveal 
                  show={true} 
                  answer="No — barley gets you different amounts depending on what you're trading for (2 barley for 1 wool, but 4 barley for 1 pot)." 
                />
              )}
            </div>
            
            {/* Explanation after submission */}
            {q5Submitted && (
              <>
                <InsightPanel>
                  <p className="mb-2">
                    Barley doesn't have "a worth" — it has what it can get you. And that depends on what you're trading for.
                  </p>
                  <ul className="mb-2 space-y-1">
                    <li>• 2 barley gets you 1 wool</li>
                    <li>• 4 barley gets you 1 pot</li>
                  </ul>
                  <p>
                    Those are different trades, not one number.
                  </p>
                </InsightPanel>
                
                <KeyInsightBox>
                  <p className="mb-2">
                    Every good's "worth" is relative — what can this get me in terms of <em>that</em>?
                  </p>
                  <p>
                    The common standard is conventional, not fundamental. It picks one good as the reference point so comparisons are easier. But the underlying exchange relationships exist independently of which standard you choose.
                  </p>
                </KeyInsightBox>
                
                <ContinueButton onClick={() => setPhase('coda')}>
                  Continue
                </ContinueButton>
              </>
            )}
          </div>
        </div>
      );

      // CODA
      const renderCoda = () => (
        <div className="min-h-screen fade-in" style={{ backgroundColor: colors.sand }}>
          <div className="p-4 max-w-2xl mx-auto pb-20">
            <Header />

            <PreviousPageButton onClick={() => setPhase('phase5')} />

            <NarrativeBlock>
              <p className="mb-3">
                That evening, Kira finds you by the river.
              </p>
              <p className="mb-3">
                "You learned fast," she says. "Most people never see it."
              </p>
              <p className="mb-3">
                You're still thinking about the barley. How it made everything comparable. How the gaps became visible.
              </p>
              <p className="mb-3">
                "Barley works," Kira says, "because everyone trades in it. Everyone knows what barley can get them."
              </p>
              <p className="mb-3">
                She pauses.
              </p>
              <p className="mb-3">
                "But barley has its own problems. Good harvest, bad harvest — the supply changes. When that happens, all the barley-numbers shift. Even if nothing else has changed."
              </p>
              <p className="italic">
                She doesn't say more. But you're left wondering: what happens when the standard itself moves?
              </p>
            </NarrativeBlock>
            
            <ContinueButton onClick={() => setPhase('complete')}>
              Complete Tutorial
            </ContinueButton>
          </div>
        </div>
      );

      // COMPLETE
      const renderComplete = () => (
        <div className="min-h-screen fade-in" style={{ backgroundColor: colors.sand }}>
          <div className="p-4 max-w-2xl mx-auto pb-20">
            <Header />

            <PreviousPageButton onClick={() => setPhase('coda')} />

            {/* Trophy */}
            <div className="text-center mb-6">
              <div 
                className="inline-flex items-center justify-center w-20 h-20 rounded-full mb-4"
                style={{ backgroundColor: colors.accent }}
              >
                <span className="text-white"><TrophyIcon /></span>
              </div>
              <h2 className="text-2xl font-bold" style={{ color: colors.primary }}>
                Tutorial Complete!
              </h2>
            </div>
            
            {/* What You Discovered */}
            <div 
              className="rounded-lg p-4 mb-4 border-2"
              style={{ backgroundColor: 'white', borderColor: colors.success }}
            >
              <h3 className="font-bold mb-3" style={{ color: colors.primary }}>What You Discovered</h3>
              <ol className="space-y-2 text-sm" style={{ color: colors.earthDark }}>
                <li className="flex gap-2">
                  <span style={{ color: colors.success }}>✓</span>
                  Exchange ratios are hard to compare directly — different units, no common basis
                </li>
                <li className="flex gap-2">
                  <span style={{ color: colors.success }}>✓</span>
                  A common standard (barley) makes all goods commensurable — "6 barley for 8 barley" is obviously a gain
                </li>
                <li className="flex gap-2">
                  <span style={{ color: colors.success }}>✓</span>
                  Arbitrage makes rates line up — inconsistencies get exploited until they disappear
                </li>
                <li className="flex gap-2">
                  <span style={{ color: colors.success }}>✓</span>
                  The standard is a lens, not the source — you could use wool instead; same structure, different numbers
                </li>
                <li className="flex gap-2">
                  <span style={{ color: colors.success }}>✓</span>
                  Every good's "worth" is relative — what can this get me in terms of <em>that</em>?
                </li>
              </ol>
            </div>
            
            {/* The Deeper Point */}
            <KeyInsightBox>
              <p className="font-semibold mb-2">The Deeper Point</p>
              <p>
                Exchange doesn't just set relationships pair by pair. Arbitrage knits all the relationships together into a consistent structure. The common standard lets you see that structure — but arbitrage is what creates it.
              </p>
            </KeyInsightBox>
            
            {/* Coming Next */}
            <div 
              className="rounded-lg p-4 mb-4"
              style={{ backgroundColor: colors.clayLight }}
            >
              <h3 className="font-bold mb-2" style={{ color: colors.primary }}>Coming Next</h3>
              <p className="text-sm" style={{ color: colors.earthDark }}>
                But what happens when the standard itself shifts? When barley's supply changes with the harvest, all the barley-numbers change — even if nothing real has moved.
              </p>
              <p className="font-bold mt-2" style={{ color: colors.primary }}>
                Next: Tutorial 1.5 — The Bountiful Harvest
              </p>
            </div>
            
            {/* Optional Workshop */}
            <div 
              className="rounded-lg p-4 mb-4 border"
              style={{ backgroundColor: 'white', borderColor: colors.earthLight }}
            >
              <p className="text-sm" style={{ color: colors.earthDark }}>
                <strong>Want to explore arbitrage further?</strong> The Arbitrageur's Workshop lets you build profitable cycles, discover reversed mispricings, and see how arbitrage corrects markets. (Available separately)
              </p>
            </div>
            
            {/* Next Tutorial Button */}
            <a
              href="tutorial-1-5.html"
              onClick={() => playContinueClick()}
              className="w-full py-3 rounded-lg font-bold text-white flex items-center justify-center gap-2 btn-primary transition-all mb-3 no-underline"
              style={{ backgroundColor: colors.primary }}
            >
              Next Tutorial: The Bountiful Harvest <ChevronRightIcon />
            </a>
            
            {/* Restart */}
            <button
              onClick={handleRestart}
              className="w-full py-3 rounded-lg font-bold border-2 flex items-center justify-center gap-2 transition-all hover:bg-gray-50"
              style={{ borderColor: colors.primary, color: colors.primary }}
            >
              <RefreshIcon /> Restart Tutorial
            </button>
          </div>
        </div>
      );

      // ============================================================
      // MAIN RENDER
      // ============================================================
      return (
        <>
          {showGlossary && <GlossaryModal />}
          
          {phase === 'welcome' && renderWelcome()}
          {phase === 'phase1' && renderPhase1()}
          {phase === 'phase2' && renderPhase2()}
          {phase === 'phase3' && renderPhase3()}
          {phase === 'phase4' && renderPhase4()}
          {phase === 'phase5' && renderPhase5()}
          {phase === 'coda' && renderCoda()}
          {phase === 'complete' && renderComplete()}
        </>
      );
    };

    // Render the app
    ReactDOM.render(<Tutorial14 />, document.getElementById('root'));
  </script>

    <!-- Navigation Footer -->
    <div style="position: fixed; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,53,107,0.95), rgba(0,53,107,0.85)); backdrop-filter: blur(8px); border-top: 1px solid rgba(255,255,255,0.1); padding: 12px 16px; z-index: 40;">
        <div style="max-width: 42rem; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; gap: 12px;">
            <a href="tutorial-1-3.html" style="flex: 1; padding: 10px 16px; background: rgba(255,255,255,0.1); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 14px; text-align: center; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                <span style="display: flex; align-items: center; gap: 4px;"><span style="font-size: 16px;">←</span> Previous</span>
                <span style="font-size: 11px; opacity: 0.8;">Tutorial 1.3</span>
            </a>
            <a href="../index.html" style="flex: 1; padding: 10px 16px; background: rgba(201,162,39,0.9); color: white; text-decoration: none; border-radius: 8px; font-weight: 700; font-size: 14px; text-align: center; transition: all 0.2s;" onmouseover="this.style.background='rgba(201,162,39,1)'" onmouseout="this.style.background='rgba(201,162,39,0.9)'">
                Hub
            </a>
            <a href="tutorial-1-5.html" style="flex: 1; padding: 10px 16px; background: rgba(255,255,255,0.1); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 14px; text-align: center; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                <span style="display: flex; align-items: center; gap: 4px;">Next <span style="font-size: 16px;">→</span></span>
                <span style="font-size: 11px; opacity: 0.8;">Tutorial 1.5</span>
            </a>
        </div>
    </div>
</body>
</html>
